<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .card { box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075); }
        .status-badge { font-size: 0.875rem; }
        .agent-card { border-left: 4px solid #007bff; }
        .logs-container {
            height: 70vh;
            overflow-y: auto;
            background: #f8f9fa;
            font-family: 'SF Mono', 'Monaco', 'Cascadia Code', 'Roboto Mono', monospace;
            font-size: 0.85rem;
            line-height: 1.4;
            border: 1px solid #e9ecef;
        }
        
        .logs-container.fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 9999;
            background: white;
            border: none;
        }
        
        .log-entry {
            padding: 0.5rem 1rem;
            border-bottom: 1px solid #e9ecef;
            margin: 0;
        }
        
        .log-entry.disruption { border-left: 4px solid #dc3545; }
        .log-entry.crew_analysis { border-left: 4px solid #0dcaf0; }
        .log-entry.resolution { border-left: 4px solid #198754; }
        .log-entry.normal { border-left: 4px solid #6c757d; }
        
        .log-entry:hover {
            background-color: #f8f9fa;
            cursor: pointer;
        }
        
        .agent-response-card {
            border-left: 4px solid #007bff;
            transition: all 0.3s ease;
        }
        
        .agent-response-card:hover {
            box-shadow: 0 0.25rem 0.5rem rgba(0, 0, 0, 0.1);
            transform: translateY(-1px);
        }
        
        .confidence-high { color: #28a745; }
        .confidence-medium { color: #ffc107; }
        .confidence-low { color: #dc3545; }
        
        .log-timestamp {
            color: #6c757d;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .log-content {
            margin-top: 0.25rem;
            white-space: pre-wrap;
        }
        
        .metric-card { text-align: center; }
        .processing { animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-plane"></i> IOCCA Hub
            </a>
            <span class="navbar-text">
                Day Simulation - Crew Operations Management
            </span>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Status Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="fas fa-play text-primary"></i>
                        </h5>
                        <h3 id="active-simulations">{{ active_simulations }}</h3>
                        <p class="text-muted">Active Simulations</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="fas fa-calendar-day text-warning"></i>
                        </h5>
                        <h3 id="total-simulations">{{ total_simulations }}</h3>
                        <p class="text-muted">Total Simulations</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="fas fa-users text-success"></i>
                        </h5>
                        <h3 id="agents-online">3</h3>
                        <p class="text-muted">Agents Online</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="fas fa-heartbeat text-info"></i>
                        </h5>
                        <h3 id="system-status">
                            <span class="badge bg-success">Healthy</span>
                        </h3>
                        <p class="text-muted">System Status</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Control Panel -->
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-control"></i> Control Panel</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <p class="text-muted mb-3">Experience a full day of airline operations with realistic crew disruptions, agent reasoning, and automated resolutions.</p>
                        </div>
                        
                        <button id="start-day-simulation" class="btn btn-primary btn-lg w-100 mb-3">
                            <i class="fas fa-calendar-day"></i> Start Day Simulation
                        </button>
                        
                        <div class="d-grid gap-2">
                            <button class="btn btn-outline-primary" onclick="refreshDashboard()">
                                <i class="fas fa-sync"></i> Refresh Dashboard
                            </button>
                            <button class="btn btn-outline-info" onclick="showConfig()">
                                <i class="fas fa-cog"></i> System Config
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Simulation Status -->
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5><i class="fas fa-calendar-day"></i> Day Simulation Status</h5>
                        <button class="btn btn-sm btn-outline-primary" onclick="loadSimulations()">
                            <i class="fas fa-sync"></i>
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="simulations-list">
                            <div class="text-center text-muted py-4">
                                <i class="fas fa-info-circle"></i>
                                <p>No simulations running. Click "Start Day Simulation" to begin.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Live Operations Log -->
                <div class="card mt-3">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5><i class="fas fa-clipboard-list"></i> Operations Log</h5>
                        <div class="btn-group btn-group-sm" role="group">
                            <button type="button" class="btn btn-outline-secondary active" onclick="filterLogs('all')">All</button>
                            <button type="button" class="btn btn-outline-warning" onclick="filterLogs('disruptions')">Disruptions</button>
                            <button type="button" class="btn btn-outline-info" onclick="filterLogs('crew_analysis')">Crew Analysis</button>
                            <button type="button" class="btn btn-outline-success" onclick="filterLogs('resolutions')">Resolutions</button>
                            <button type="button" class="btn btn-outline-dark" onclick="showAgentResponsesPanel()">
                                <i class="fas fa-robot"></i> Agent Details
                            </button>
                            <button type="button" class="btn btn-outline-primary" onclick="toggleFullscreen()">
                                <i class="fas fa-expand"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div id="operations-log" class="logs-container">
                            <div class="text-center text-muted py-4">
                                <i class="fas fa-info-circle"></i>
                                <p>Operations log will appear here...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global variables
        let refreshInterval;
        let currentSimulationId = null;
        let websocket = null;

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            checkSystemHealth();
            loadSimulations();
            startAutoRefresh();
            connectWebSocket();
        });

        // Start day simulation
        document.getElementById('start-day-simulation').addEventListener('click', async function() {
            const button = this;
            
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Starting...';

            try {
                const response = await fetch('/api/simulation/start-day', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    currentSimulationId = result.simulation_id;
                    addLog(`Day simulation started: ${result.simulation_id}`, 'info');
                    loadSimulations();
                    monitorSimulation(result.simulation_id);
                } else {
                    addLog(`Error: ${result.detail}`, 'error');
                }
            } catch (error) {
                addLog(`Error: ${error.message}`, 'error');
            } finally {
                button.disabled = false;
                button.innerHTML = '<i class="fas fa-calendar-day"></i> Start Day Simulation';
            }
        });

        // WebSocket handling
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws`;
            
            websocket = new WebSocket(wsUrl);
            
            websocket.onopen = function(event) {
                console.log('WebSocket connected');
                addLog('Real-time monitoring connected', 'info');
            };
            
            websocket.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    handleWebSocketMessage(data);
                } catch (error) {
                    console.error('Error parsing WebSocket message:', error);
                }
            };
            
            websocket.onclose = function(event) {
                console.log('WebSocket disconnected');
                addLog('Real-time monitoring disconnected', 'warning');
                setTimeout(connectWebSocket, 5000);
            };
            
            websocket.onerror = function(error) {
                console.error('WebSocket error:', error);
                addLog('WebSocket connection error', 'error');
            };
        }

        // Handle WebSocket messages
        function handleWebSocketMessage(data) {
            if (data.type === 'simulation_event') {
                handleSimulationEvent(data);
            } else if (data.type === 'simulation_complete') {
                handleSimulationComplete(data);
            } else if (data.type === 'simulation_error') {
                handleSimulationError(data);
            }
        }

        // Handle simulation events
        function handleSimulationEvent(data) {
            const event = data.event;
            let logMessage = '';
            let logType = 'info';
            
            switch (event.type) {
                case 'time_update':
                    logMessage = `â° ${event.message}`;
                    logType = 'info';
                    break;
                case 'normal_operation':
                    logMessage = `âœ… ${event.flight_id} departed on time from ${event.origin} to ${event.destination}`;
                    logType = 'success';
                    break;
                case 'disruption_detected':
                    logMessage = `âš ï¸ DISRUPTION: ${event.flight_id} - ${event.description}`;
                    logType = 'disruption';
                    break;
                case 'crew_analysis':
                    logMessage = `ðŸ‘¥ CREW ANALYSIS: ${event.flight_id} - ${event.reasoning.substring(0, 100)}...`;
                    logType = 'crew_analysis';
                    // Store full event data for detailed view
                    storeEventForDetails(event);
                    break;
                case 'ops_support':
                    logMessage = `ðŸ¨ OPS SUPPORT: ${event.flight_id} - ${event.reasoning.substring(0, 100)}...`;
                    logType = 'crew_analysis';
                    // Store full event data for detailed view
                    storeEventForDetails(event);
                    break;
                case 'disruption_resolved':
                    logMessage = `âœ… RESOLVED: ${event.flight_id} - ${event.resolution}`;
                    logType = 'resolution';
                    break;
                case 'llm_crew_reasoning':
                    if (event.llm_event && event.llm_event.type === 'token') {
                        return;
                    }
                    logMessage = `ðŸ¤– CREW LLM: ${event.flight_id} - Live reasoning in progress`;
                    logType = 'crew_analysis';
                    break;
                case 'llm_ops_reasoning':
                    if (event.llm_event && event.llm_event.type === 'token') {
                        return;
                    }
                    logMessage = `ðŸ¤– OPS LLM: ${event.flight_id} - Live reasoning in progress`;
                    logType = 'crew_analysis';
                    break;
                default:
                    logMessage = `ðŸ“‹ ${event.type}: ${JSON.stringify(event)}`;
                    logType = 'info';
            }
            
            addLog(logMessage, logType, event);
            loadSimulations();
        }

        // Handle simulation completion
        function handleSimulationComplete(data) {
            addLog(`ðŸŽ‰ Day simulation completed: ${data.simulation_id}`, 'success');
            currentSimulationId = null;
            loadSimulations();
        }

        // Handle simulation error
        function handleSimulationError(data) {
            addLog(`âŒ Simulation error: ${data.error}`, 'error');
            currentSimulationId = null;
            loadSimulations();
        }

        // Monitor simulation status
        async function monitorSimulation(simulationId) {
            while (currentSimulationId === simulationId) {
                try {
                    const response = await fetch(`/api/simulation/${simulationId}`);
                    const data = await response.json();
                    
                    if (data.status === 'completed') {
                        addLog(`Simulation ${simulationId} completed successfully`, 'success');
                        loadSimulations();
                        currentSimulationId = null;
                        break;
                    } else if (data.status === 'failed') {
                        addLog(`Simulation ${simulationId} failed: ${data.error}`, 'error');
                        loadSimulations();
                        currentSimulationId = null;
                        break;
                    }
                    
                    await new Promise(resolve => setTimeout(resolve, 2000));
                } catch (error) {
                    addLog(`Error monitoring simulation: ${error.message}`, 'error');
                    break;
                }
            }
        }

        // Load simulations
        async function loadSimulations() {
            try {
                const response = await fetch('/api/simulations');
                const data = await response.json();
                
                const container = document.getElementById('simulations-list');
                
                if (data.simulations.length === 0) {
                    container.innerHTML = `
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-info-circle"></i>
                            <p>No simulations running. Click "Start Day Simulation" to begin.</p>
                        </div>
                    `;
                } else {
                    container.innerHTML = data.simulations.map(simulation => `
                        <div class="border rounded p-3 mb-2">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h6 class="mb-1">Simulation ${simulation.simulation_id.substring(0, 8)}</h6>
                                    <p class="text-muted mb-1">${simulation.type || 'Day Simulation'}</p>
                                    <small class="text-muted">${new Date(simulation.start_time).toLocaleString()}</small>
                                </div>
                                <span class="badge bg-${getStatusColor(simulation.status)} ${simulation.status === 'running' ? 'processing' : ''}">
                                    ${simulation.status}
                                </span>
                            </div>
                            ${simulation.end_time ? `
                                <div class="mt-2 pt-2 border-top">
                                    <small><strong>Completed:</strong> ${new Date(simulation.end_time).toLocaleString()}</small>
                                </div>
                            ` : ''}
                        </div>
                    `).join('');
                }
                
                // Update metrics
                document.getElementById('active-simulations').textContent = data.active;
                document.getElementById('total-simulations').textContent = data.total;
                
            } catch (error) {
                console.error('Error loading simulations:', error);
                addLog(`Error loading simulations: ${error.message}`, 'error');
            }
        }

        // Utility functions
        function getStatusColor(status) {
            switch (status) {
                case 'running': return 'primary';
                case 'completed': return 'success';
                case 'failed': return 'danger';
                case 'processing': return 'warning';
                default: return 'secondary';
            }
        }

        // Global storage for detailed event data
        let detailedEvents = {};
        
        function storeEventForDetails(event) {
            const eventId = `${event.type}_${event.flight_id || 'unknown'}_${event.sim_time || Date.now()}`;
            detailedEvents[eventId] = event;
        }
        
        function addLog(message, type, eventData = null) {
            const container = document.getElementById('operations-log');
            const timestamp = new Date().toLocaleTimeString();
            
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            logEntry.setAttribute('data-type', type);
            
            let expandButton = '';
            if (eventData && (eventData.type === 'crew_analysis' || eventData.type === 'ops_support')) {
                const eventId = `${eventData.type}_${eventData.flight_id || 'unknown'}_${eventData.sim_time || Date.now()}`;
                expandButton = `<button class="btn btn-sm btn-outline-info ms-2" onclick="showEventDetails('${eventId}')">
                    <i class="fas fa-expand-alt"></i> Details
                </button>`;
            }
            
            logEntry.innerHTML = `
                <div class="log-timestamp">${timestamp}</div>
                <div class="log-content">
                    ${message}
                    ${expandButton}
                </div>
            `;
            
            container.appendChild(logEntry);
            container.scrollTop = container.scrollHeight;
            
            // Keep only last 100 log entries
            while (container.children.length > 100) {
                container.removeChild(container.firstChild);
            }
        }

        function filterLogs(filterType) {
            const container = document.getElementById('operations-log');
            const entries = container.querySelectorAll('.log-entry');
            
            // Update button states
            document.querySelectorAll('.btn-group button').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            entries.forEach(entry => {
                if (filterType === 'all') {
                    entry.style.display = 'block';
                } else {
                    const entryType = entry.getAttribute('data-type');
                    if (filterType === 'disruptions' && entryType === 'disruption') {
                        entry.style.display = 'block';
                    } else if (filterType === 'crew_analysis' && entryType === 'crew_analysis') {
                        entry.style.display = 'block';
                    } else if (filterType === 'resolutions' && entryType === 'resolution') {
                        entry.style.display = 'block';
                    } else {
                        entry.style.display = 'none';
                    }
                }
            });
        }

        function toggleFullscreen() {
            const container = document.getElementById('operations-log');
            container.classList.toggle('fullscreen');
        }

        function refreshDashboard() {
            location.reload();
        }

        function showConfig() {
            fetch('/api/config')
                .then(response => response.json())
                .then(data => {
                    alert('System Configuration:\n' + JSON.stringify(data, null, 2));
                })
                .catch(error => {
                    addLog(`Error loading config: ${error.message}`, 'error');
                });
        }

        async function checkSystemHealth() {
            try {
                const response = await fetch('/api/health');
                const data = await response.json();
                
                const statusElement = document.getElementById('system-status');
                if (data.status === 'healthy') {
                    statusElement.innerHTML = '<span class="badge bg-success">Healthy</span>';
                } else {
                    statusElement.innerHTML = '<span class="badge bg-danger">Unhealthy</span>';
                }
            } catch (error) {
                document.getElementById('system-status').innerHTML = '<span class="badge bg-danger">Error</span>';
            }
        }

        function startAutoRefresh() {
            refreshInterval = setInterval(() => {
                loadSimulations();
                checkSystemHealth();
            }, 10000); // Refresh every 10 seconds
        }

        // Agent response panel functions
        function showAgentResponsesPanel() {
            if (!currentSimulationId) {
                alert('No active simulation to show agent responses for.');
                return;
            }
            
            // Create modal for agent responses
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.id = 'agentResponsesModal';
            modal.innerHTML = `
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Agent Response Analysis</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="d-flex justify-content-between mb-3">
                                <div>
                                    <button class="btn btn-sm btn-outline-primary" onclick="loadAgentResponses('crew_assignment')">Crew Responses</button>
                                    <button class="btn btn-sm btn-outline-secondary" onclick="loadAgentResponses('ops_support')">Ops Responses</button>
                                    <button class="btn btn-sm btn-outline-dark" onclick="loadAgentResponses('')">All Responses</button>
                                </div>
                                <div>
                                    <button class="btn btn-sm btn-success" onclick="exportAgentResponses('json')">Export JSON</button>
                                    <button class="btn btn-sm btn-info" onclick="exportAgentResponses('csv')">Export CSV</button>
                                </div>
                            </div>
                            <div id="agentResponsesContent">
                                <div class="text-center text-muted py-4">
                                    <i class="fas fa-robot fa-2x"></i>
                                    <p>Loading agent responses...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
            
            // Load all responses by default
            loadAgentResponses('');
            
            // Clean up when modal is hidden
            modal.addEventListener('hidden.bs.modal', function() {
                document.body.removeChild(modal);
            });
        }
        
        async function loadAgentResponses(agentType = '') {
            if (!currentSimulationId) return;
            
            try {
                const url = `/api/simulation/${currentSimulationId}/agent-responses${agentType ? `?agent_type=${agentType}` : ''}`;
                const response = await fetch(url);
                const data = await response.json();
                
                const container = document.getElementById('agentResponsesContent');
                
                if (data.agent_responses.length === 0) {
                    container.innerHTML = `
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-info-circle"></i>
                            <p>No agent responses found for the selected filter.</p>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = data.agent_responses.map(response => `
                    <div class="card mb-3">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">
                                <i class="fas fa-${response.agent_type === 'crew_assignment' ? 'users' : 'hotel'}"></i>
                                ${response.agent_type === 'crew_assignment' ? 'Crew Assignment' : 'Operations Support'} - ${response.flight_id}
                                <span class="badge bg-${getConfidenceBadgeColor(response.confidence_level)} ms-2">${response.confidence_level} confidence</span>
                            </h6>
                            <small class="text-muted">${new Date(response.timestamp).toLocaleString()}</small>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-8">
                                    <h6>Reasoning:</h6>
                                    <p class="small">${response.reasoning}</p>
                                </div>
                                <div class="col-md-4">
                                    <h6>Analysis Details:</h6>
                                    <ul class="list-unstyled small">
                                        ${Object.entries(response.detailed_analysis || {}).map(([key, value]) => 
                                            `<li><strong>${key.replace(/_/g, ' ')}:</strong> ${Array.isArray(value) ? value.join(', ') : value}</li>`
                                        ).join('')}
                                    </ul>
                                    ${response.handoff_required ? `<div class="alert alert-info small"><strong>Handoff:</strong> ${response.handoff_context}</div>` : ''}
                                    ${response.booking_confirmed ? `<div class="alert alert-success small"><strong>Booking:</strong> Confirmed</div>` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('Error loading agent responses:', error);
                document.getElementById('agentResponsesContent').innerHTML = `
                    <div class="alert alert-danger">
                        Error loading agent responses: ${error.message}
                    </div>
                `;
            }
        }
        
        function getConfidenceBadgeColor(level) {
            switch(level) {
                case 'high': return 'success';
                case 'medium': return 'warning';
                case 'low': return 'danger';
                default: return 'secondary';
            }
        }
        
        function showEventDetails(eventId) {
            const event = detailedEvents[eventId];
            if (!event) {
                alert('Event details not found.');
                return;
            }
            
            // Create detailed event modal
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.innerHTML = `
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Event Details - ${event.flight_id}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <pre class="bg-light p-3 rounded">${JSON.stringify(event, null, 2)}</pre>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
            
            modal.addEventListener('hidden.bs.modal', function() {
                document.body.removeChild(modal);
            });
        }
        
        async function exportAgentResponses(format) {
            if (!currentSimulationId) return;
            
            try {
                const url = `/api/simulation/${currentSimulationId}/agent-responses/export?format=${format}`;
                const response = await fetch(url);
                
                if (response.ok) {
                    const blob = await response.blob();
                    const downloadUrl = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = downloadUrl;
                    a.download = `agent_responses_${currentSimulationId}.${format}`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(downloadUrl);
                } else {
                    alert('Error exporting agent responses');
                }
            } catch (error) {
                console.error('Export error:', error);
                alert('Error exporting agent responses');
            }
        }
        
        // Handle page visibility changes
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                clearInterval(refreshInterval);
            } else {
                startAutoRefresh();
            }
        });
    </script>
</body>
</html>