<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }} | United Airlines IOCCA Hub</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* United Airlines Typography */
        body { 
            background-color: #f8f9fa; 
            font-family: 'Helvetica Neue', 'Arial', sans-serif;
        }
        
        /* United Airlines Color Palette */
        :root {
            --united-blue: #004E9E;
            --united-dark-blue: #003366;
            --united-light-blue: #009CDE;
            --united-gold: #FFB700;
            --united-gray: #6C757D;
            --united-light-gray: #F8F9FA;
        }
        
        .card { 
            box-shadow: 0 0.125rem 0.25rem rgba(0, 78, 158, 0.1);
            border: 1px solid rgba(0, 78, 158, 0.1);
        }
        .status-badge { font-size: 0.875rem; }
        .agent-card { border-left: 4px solid var(--united-blue); }
        .logs-container {
            height: 70vh;
            overflow-y: auto;
            background: #f8f9fa;
            font-family: 'SF Mono', 'Monaco', 'Cascadia Code', 'Roboto Mono', monospace;
            font-size: 0.85rem;
            line-height: 1.4;
            border: 1px solid #e9ecef;
        }
        
        .logs-container.fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 9999;
            background: white;
            border: none;
        }
        
        .log-entry {
            padding: 0.5rem 1rem;
            border-bottom: 1px solid #e9ecef;
            margin: 0;
            position: relative;
        }
        
        .log-entry.disruption { border-left: 4px solid #dc3545; }
        .log-entry.crew_analysis { border-left: 4px solid #0dcaf0; }
        .log-entry.resolution { border-left: 4px solid #198754; }
        .log-entry.normal { border-left: 4px solid #6c757d; }
        
        .log-entry:hover {
            background-color: #f8f9fa;
            cursor: pointer;
        }
        
        /* Inline Reasoning Display */
        .inline-reasoning-container {
            margin: 0.5rem 0 0.5rem 2rem;
            padding: 1rem;
            background: #ffffff;
            border: 2px solid var(--united-blue);
            border-radius: 0.5rem;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 78, 158, 0.1);
            display: none;
        }
        
        .inline-reasoning-container.active {
            display: block;
            animation: slideDown 0.3s ease-out;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .inline-reasoning-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #e9ecef;
        }
        
        .inline-reasoning-content {
            font-family: 'SF Mono', 'Monaco', 'Cascadia Code', 'Roboto Mono', monospace;
            font-size: 0.85rem;
            line-height: 1.6;
            color: #333;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .reasoning-expand-btn {
            background: var(--united-light-blue);
            color: white;
            border: none;
            padding: 0.25rem 0.75rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .reasoning-expand-btn:hover {
            background: var(--united-blue);
            transform: translateY(-1px);
        }
        
        .reasoning-expand-btn.active {
            background: var(--united-blue);
        }
        
        .agent-response-card {
            border-left: 4px solid var(--united-blue);
            transition: all 0.3s ease;
        }
        
        .agent-response-card:hover {
            box-shadow: 0 0.25rem 0.5rem rgba(0, 0, 0, 0.1);
            transform: translateY(-1px);
        }
        
        .confidence-high { color: #28a745; }
        .confidence-medium { color: #ffc107; }
        .confidence-low { color: #dc3545; }
        
        .log-timestamp {
            color: #6c757d;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .log-content {
            margin-top: 0.25rem;
            white-space: pre-wrap;
        }
        
        .metric-card { 
            text-align: center; 
            border-radius: 8px;
            transition: transform 0.2s ease-in-out;
        }
        
        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 78, 158, 0.15);
        }
        
        .processing { animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        
        /* United Airlines Section Headers */
        .card-header {
            background-color: var(--united-light-gray);
            border-bottom: 2px solid var(--united-blue);
            font-weight: 600;
        }
        
        .card-header h5 {
            color: var(--united-blue);
            margin-bottom: 0;
            font-weight: 700;
        }
        
        /* Enhanced Button Styling */
        .btn-outline-primary {
            border-color: var(--united-blue);
            color: var(--united-blue);
        }
        
        .btn-outline-primary:hover {
            background-color: var(--united-blue);
            border-color: var(--united-blue);
        }
        
        .btn-primary {
            background-color: var(--united-blue);
            border-color: var(--united-blue);
        }
        
        .btn-primary:hover {
            background-color: var(--united-dark-blue);
            border-color: var(--united-dark-blue);
        }
        
        /* Operations Event Badges (replaces confidence for operations) */
        .ops-event-badge {
            display: inline-block;
            padding: 0.125rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.6rem;
            font-weight: 600;
            text-transform: uppercase;
            margin-left: 0.5rem;
        }
        
        .ops-event-badge.success {
            background-color: #198754;
            color: white;
        }
        
        .ops-event-badge.warning {
            background-color: #ffc107;
            color: black;
        }
        
        .ops-event-badge.error {
            background-color: #dc3545;
            color: white;
        }
        
        .ops-event-badge.info {
            background-color: var(--united-light-blue);
            color: white;
        }
        
        /* Inline Reasoning Stream Styles */
        .reasoning-stream-title {
            font-weight: 700;
            color: var(--united-blue);
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .reasoning-step-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin: 0.5rem 0;
            padding: 0.5rem;
            background: var(--united-light-gray);
            border-radius: 0.25rem;
            font-weight: 600;
            color: var(--united-blue);
        }
        
        .reasoning-highlight {
            background-color: #ffffcc;
            padding: 0.125rem 0.25rem;
            border-radius: 0.125rem;
            font-weight: 600;
        }
        
        .reasoning-tool-usage {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            background: var(--united-light-blue);
            color: white;
            border-radius: 0.25rem;
            font-size: 0.85rem;
            font-weight: 600;
            margin: 0 0.25rem;
        }
        
        .reasoning-handoff-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem;
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 0.5rem;
            margin: 0.5rem 0;
            font-weight: 600;
            color: #856404;
        }
        
        .reasoning-confidence-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .reasoning-confidence-indicator.high {
            background: #d4edda;
            color: #155724;
        }
        
        .reasoning-confidence-indicator.medium {
            background: #fff3cd;
            color: #856404;
        }
        
        .reasoning-confidence-indicator.low {
            background: #f8d7da;
            color: #721c24;
        }
        
        .reasoning-typing-indicator {
            display: inline-block;
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light" style="background-color: #ffffff; border-bottom: 3px solid var(--united-blue); box-shadow: 0 2px 4px rgba(0,78,158,0.1);">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center" href="/" style="color: var(--united-blue); font-weight: 600; text-decoration: none;">
                <img src="https://www.logo.wine/a/logo/United_Airlines/United_Airlines-Logo.wine.svg" alt="United Airlines" height="36" class="me-3" style="filter: none; background: white; padding: 2px; border-radius: 4px;">
                <span style="font-size: 1.5rem; color: var(--united-blue); font-weight: 700;">IOCCA Hub</span>
            </a>
            <span class="navbar-text" style="color: var(--united-blue); font-weight: 500;">
                Day Simulation - Crew Operations Management
            </span>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Status Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="fas fa-play" style="color: var(--united-blue);"></i>
                        </h5>
                        <h3 id="active-simulations" style="color: var(--united-blue); font-weight: 700;">{{ active_simulations }}</h3>
                        <p class="text-muted">Active Simulations</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="fas fa-calendar-day" style="color: var(--united-gold);"></i>
                        </h5>
                        <h3 id="total-simulations" style="color: var(--united-blue); font-weight: 700;">{{ total_simulations }}</h3>
                        <p class="text-muted">Total Simulations</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="fas fa-users" style="color: var(--united-light-blue);"></i>
                        </h5>
                        <h3 id="agents-online" style="color: var(--united-blue); font-weight: 700;">3</h3>
                        <p class="text-muted">Agents Online</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="fas fa-heartbeat" style="color: var(--united-light-blue);"></i>
                        </h5>
                        <h3 id="system-status">
                            <span class="badge bg-success">Healthy</span>
                        </h3>
                        <p class="text-muted">System Status</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Control Panel -->
            <div class="col-md-3">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-control"></i> Control Panel</h5>
                    </div>
                    <div class="card-body">
                        <button id="start-day-simulation" class="btn btn-lg w-100 mb-3" style="background-color: var(--united-blue); border-color: var(--united-blue); color: white; font-weight: 600;"
                            <i class="fas fa-calendar-day"></i> Start Day Simulation
                        </button>
                        
                        <div class="d-grid gap-2">
                            <button class="btn btn-sm" onclick="refreshDashboard()" style="border-color: var(--united-blue); color: var(--united-blue);"
                                <i class="fas fa-sync"></i> Refresh
                            </button>
                            <button class="btn btn-sm" onclick="showConfig()" style="border-color: var(--united-light-blue); color: var(--united-light-blue);"
                                <i class="fas fa-cog"></i> Config
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Simulation Status and Operations Log -->
            <div class="col-md-9">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5><i class="fas fa-calendar-day"></i> Day Simulation Status</h5>
                        <button class="btn btn-sm btn-outline-primary" onclick="loadSimulations()" style="border-color: var(--united-blue); color: var(--united-blue);">
                            <i class="fas fa-sync"></i>
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="simulations-list">
                            <div class="text-center text-muted py-4">
                                <i class="fas fa-info-circle"></i>
                                <p>No simulations running. Click "Start Day Simulation" to begin.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Live Operations Log -->
                <div class="card mt-3">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5><i class="fas fa-clipboard-list"></i> Operations Log</h5>
                        <div class="btn-group btn-group-sm" role="group">
                            <button type="button" class="btn btn-outline-secondary active" onclick="filterLogs('all')">All</button>
                            <button type="button" class="btn btn-outline-warning" onclick="filterLogs('disruptions')">Disruptions</button>
                            <button type="button" class="btn btn-outline-info" onclick="filterLogs('crew_analysis')">Crew Analysis</button>
                            <button type="button" class="btn btn-outline-success" onclick="filterLogs('resolutions')">Resolutions</button>
                            <button type="button" class="btn btn-outline-dark" onclick="showAgentResponsesPanel()">
                                <i class="fas fa-robot"></i> Agent Details
                            </button>
                            <button type="button" class="btn btn-outline-primary" onclick="toggleFullscreen()">
                                <i class="fas fa-expand"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div id="operations-log" class="logs-container">
                            <div class="text-center text-muted py-4">
                                <i class="fas fa-info-circle"></i>
                                <p>Operations log will appear here...</p>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global variables
        let refreshInterval;
        let currentSimulationId = null;
        let websocket = null;

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            checkSystemHealth();
            loadSimulations();
            startAutoRefresh();
            connectWebSocket();
        });

        // Start day simulation
        document.getElementById('start-day-simulation').addEventListener('click', async function() {
            const button = this;
            
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Starting...';

            try {
                const response = await fetch('/api/simulation/start-day', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    currentSimulationId = result.simulation_id;
                    addLog(`<i class="fas fa-play-circle text-primary"></i> Day simulation started: ${result.simulation_id}`, 'info');
                    loadSimulations();
                    monitorSimulation(result.simulation_id);
                } else {
                    addLog(`<i class="fas fa-exclamation-circle text-danger"></i> Error: ${result.detail}`, 'error');
                }
            } catch (error) {
                addLog(`<i class="fas fa-exclamation-circle text-danger"></i> Error: ${error.message}`, 'error');
            } finally {
                button.disabled = false;
                button.innerHTML = '<i class="fas fa-calendar-day"></i> Start Day Simulation';
            }
        });

        // WebSocket handling
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws`;
            
            websocket = new WebSocket(wsUrl);
            
            websocket.onopen = function(event) {
                console.log('WebSocket connected');
                addLog('<i class="fas fa-wifi text-success"></i> Real-time monitoring connected', 'info');
            };
            
            websocket.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    handleWebSocketMessage(data);
                } catch (error) {
                    console.error('Error parsing WebSocket message:', error);
                }
            };
            
            websocket.onclose = function(event) {
                console.log('WebSocket disconnected');
                addLog('<i class="fas fa-wifi text-warning"></i> Real-time monitoring disconnected', 'warning');
                setTimeout(connectWebSocket, 5000);
            };
            
            websocket.onerror = function(error) {
                console.error('WebSocket error:', error);
                addLog('<i class="fas fa-exclamation-triangle text-danger"></i> WebSocket connection error', 'error');
            };
        }

        // Handle WebSocket messages
        function handleWebSocketMessage(data) {
            if (data.type === 'simulation_event') {
                handleSimulationEvent(data);
            } else if (data.type === 'simulation_complete') {
                handleSimulationComplete(data);
            } else if (data.type === 'simulation_error') {
                handleSimulationError(data);
            }
        }

        // Handle simulation events
        let disruptionLogIds = {}; // Map flight IDs to log IDs for reasoning updates
        
        function handleSimulationEvent(data) {
            const event = data.event;
            let logMessage = '';
            let logType = 'info';
            let logId = null;
            
            switch (event.type) {
                case 'time_update':
                    logMessage = `Time Update: ${event.message}`;
                    logType = 'info';
                    break;
                case 'normal_operation':
                    logMessage = `<i class="fas fa-check-circle text-success"></i> ${event.flight_id} departed on time from ${event.origin} to ${event.destination}`;
                    logType = 'success';
                    break;
                case 'disruption_detected':
                    logMessage = `<i class="fas fa-exclamation-triangle text-warning"></i> DISRUPTION: ${event.flight_id} - ${event.description}`;
                    logType = 'disruption';
                    // Store the log ID for this disruption so we can add reasoning to it later
                    logId = addLog(logMessage, logType, event);
                    if (event.flight_id) {
                        disruptionLogIds[event.flight_id] = logId;
                    }
                    loadSimulations();
                    return; // Return early since addLog was already called
                    break;
                case 'crew_analysis':
                    logMessage = `<i class="fas fa-users text-info"></i> CREW ANALYSIS: ${event.flight_id} - ${event.reasoning.substring(0, 100)}...`;
                    logType = 'crew_analysis';
                    // Store full event data for detailed view
                    storeEventForDetails(event);
                    break;
                case 'ops_support':
                    logMessage = `<i class="fas fa-headset text-primary"></i> OPS SUPPORT: ${event.flight_id} - ${event.reasoning.substring(0, 100)}...`;
                    logType = 'crew_analysis';
                    // Store full event data for detailed view
                    storeEventForDetails(event);
                    break;
                case 'disruption_resolved':
                    logMessage = `<i class="fas fa-check-circle text-success"></i> RESOLVED: ${event.flight_id} - ${event.resolution}`;
                    logType = 'resolution';
                    break;
                case 'llm_crew_reasoning':
                case 'llm_ops_reasoning':
                    // Handle LLM streaming events
                    if (event.llm_event && event.flight_id && disruptionLogIds[event.flight_id]) {
                        const logId = disruptionLogIds[event.flight_id];
                        const llmEvent = event.llm_event;
                        const agentType = event.type === 'llm_crew_reasoning' ? 'crew_assignment' : 'ops_support';
                        
                        console.log(`Received ${event.type} for flight ${event.flight_id}, logId: ${logId}`, llmEvent);
                        
                        // Add agent type to the event
                        llmEvent.agentType = agentType;
                        
                        // Auto-show reasoning container if it's not visible yet
                        const reasoningContainer = document.getElementById(`reasoning-${logId}`);
                        if (reasoningContainer && !reasoningContainer.classList.contains('active')) {
                            // Auto-expand the reasoning section when streaming starts
                            toggleInlineReasoning(logId);
                        }
                        
                        // Update the inline reasoning display
                        updateInlineReasoning(logId, llmEvent.stream_id || 'unknown', llmEvent);
                    }
                    return; // Don't add a separate log entry
                    break;
                default:
                    logMessage = `<i class="fas fa-clipboard-list"></i> ${event.type}: ${JSON.stringify(event)}`;
                    logType = 'info';
            }
            
            addLog(logMessage, logType, event);
            loadSimulations();
        }

        // Handle simulation completion
        function handleSimulationComplete(data) {
            addLog(`<i class="fas fa-trophy text-success"></i> Day simulation completed: ${data.simulation_id}`, 'success');
            currentSimulationId = null;
            loadSimulations();
        }

        // Handle simulation error
        function handleSimulationError(data) {
            addLog(`<i class="fas fa-exclamation-circle text-danger"></i> Simulation error: ${data.error}`, 'error');
            currentSimulationId = null;
            loadSimulations();
        }

        // Monitor simulation status
        async function monitorSimulation(simulationId) {
            while (currentSimulationId === simulationId) {
                try {
                    const response = await fetch(`/api/simulation/${simulationId}`);
                    const data = await response.json();
                    
                    if (data.status === 'completed') {
                        addLog(`<i class="fas fa-check-circle text-success"></i> Simulation ${simulationId} completed successfully`, 'success');
                        loadSimulations();
                        currentSimulationId = null;
                        break;
                    } else if (data.status === 'failed') {
                        addLog(`<i class="fas fa-times-circle text-danger"></i> Simulation ${simulationId} failed: ${data.error}`, 'error');
                        loadSimulations();
                        currentSimulationId = null;
                        break;
                    }
                    
                    await new Promise(resolve => setTimeout(resolve, 2000));
                } catch (error) {
                    addLog(`<i class="fas fa-exclamation-triangle text-warning"></i> Error monitoring simulation: ${error.message}`, 'error');
                    break;
                }
            }
        }

        // Load simulations
        async function loadSimulations() {
            try {
                const response = await fetch('/api/simulations');
                const data = await response.json();
                
                const container = document.getElementById('simulations-list');
                
                if (data.simulations.length === 0) {
                    container.innerHTML = `
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-info-circle"></i>
                            <p>No simulations running. Click "Start Day Simulation" to begin.</p>
                        </div>
                    `;
                } else {
                    container.innerHTML = data.simulations.map(simulation => `
                        <div class="border rounded p-3 mb-2">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h6 class="mb-1">Simulation ${simulation.simulation_id.substring(0, 8)}</h6>
                                    <p class="text-muted mb-1">${simulation.type || 'Day Simulation'}</p>
                                    <small class="text-muted">${new Date(simulation.start_time).toLocaleString()}</small>
                                </div>
                                <span class="badge bg-${getStatusColor(simulation.status)} ${simulation.status === 'running' ? 'processing' : ''}">
                                    ${simulation.status}
                                </span>
                            </div>
                            ${simulation.end_time ? `
                                <div class="mt-2 pt-2 border-top">
                                    <small><strong>Completed:</strong> ${new Date(simulation.end_time).toLocaleString()}</small>
                                </div>
                            ` : ''}
                        </div>
                    `).join('');
                }
                
                // Update metrics
                document.getElementById('active-simulations').textContent = data.active;
                document.getElementById('total-simulations').textContent = data.total;
                
            } catch (error) {
                console.error('Error loading simulations:', error);
                addLog(`<i class="fas fa-exclamation-triangle text-danger"></i> Error loading simulations: ${error.message}`, 'error');
            }
        }

        // Utility functions
        function getStatusColor(status) {
            switch (status) {
                case 'running': return 'primary';
                case 'completed': return 'success';
                case 'failed': return 'danger';
                case 'processing': return 'warning';
                default: return 'secondary';
            }
        }

        // Global storage for detailed event data and reasoning streams
        let detailedEvents = {};
        let eventReasoningStreams = {};
        
        function storeEventForDetails(event) {
            const eventId = `${event.type}_${event.flight_id || 'unknown'}_${event.sim_time || Date.now()}`;
            detailedEvents[eventId] = event;
        }
        
        function addLog(message, type, eventData = null) {
            const container = document.getElementById('operations-log');
            const timestamp = new Date().toLocaleTimeString();
            
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            logEntry.setAttribute('data-type', type);
            
            // Generate unique ID for this log entry
            const logId = `log-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
            logEntry.id = logId;
            
            // Determine event category for visual styling
            let eventCategory = 'info';
            if (type === 'success' || message.includes('completed') || message.includes('departed on time')) {
                eventCategory = 'success';
            } else if (type === 'warning' || message.includes('disconnected') || message.includes('DISRUPTION')) {
                eventCategory = 'warning';
            } else if (type === 'error' || message.includes('Error') || message.includes('failed')) {
                eventCategory = 'error';
            }
            
            // Check if this is a disruption that will have reasoning
            let showReasoningBtn = '';
            if (type === 'disruption' && eventData && eventData.flight_id) {
                showReasoningBtn = `<button class="reasoning-expand-btn" onclick="toggleInlineReasoning('${logId}')">
                    <i class="fas fa-brain"></i> Show AI Reasoning
                </button>`;
                // Store the event data for later reasoning display
                eventReasoningStreams[logId] = {
                    flightId: eventData.flight_id,
                    eventData: eventData,
                    reasoningStarted: false
                };
            }
            
            // Add event category indicator
            const categoryBadge = `<span class="ops-event-badge ${eventCategory}">${eventCategory.toUpperCase()}</span>`;
            
            logEntry.innerHTML = `
                <div class="log-timestamp">${timestamp} ${categoryBadge}</div>
                <div class="log-content">
                    ${message}
                    ${showReasoningBtn}
                </div>
            `;
            
            // Add reasoning container placeholder
            if (showReasoningBtn) {
                const reasoningContainer = document.createElement('div');
                reasoningContainer.className = 'inline-reasoning-container';
                reasoningContainer.id = `reasoning-${logId}`;
                logEntry.appendChild(reasoningContainer);
            }
            
            container.appendChild(logEntry);
            container.scrollTop = container.scrollHeight;
            
            // Keep only last 100 log entries
            while (container.children.length > 100) {
                container.removeChild(container.firstChild);
            }
            
            return logId;
        }
        
        function toggleInlineReasoning(logId) {
            const reasoningContainer = document.getElementById(`reasoning-${logId}`);
            const button = document.querySelector(`#${logId} .reasoning-expand-btn`);
            
            console.log(`toggleInlineReasoning called for logId: ${logId}`);
            
            if (!reasoningContainer) {
                console.error(`Reasoning container not found for logId: ${logId}`);
                return;
            }
            
            if (reasoningContainer.classList.contains('active')) {
                reasoningContainer.classList.remove('active');
                if (button) {
                    button.innerHTML = '<i class="fas fa-brain"></i> Show AI Reasoning';
                    button.classList.remove('active');
                }
            } else {
                reasoningContainer.classList.add('active');
                if (button) {
                    button.innerHTML = '<i class="fas fa-brain"></i> Hide AI Reasoning';
                    button.classList.add('active');
                }
                
                // If reasoning hasn't started yet, show placeholder
                if (!eventReasoningStreams[logId] || !eventReasoningStreams[logId].reasoningStarted) {
                    console.log(`Showing placeholder for logId: ${logId}`);
                    reasoningContainer.innerHTML = `
                        <div class="inline-reasoning-header">
                            <div class="reasoning-stream-title">
                                <i class="fas fa-brain"></i>
                                <span>AI Agent Reasoning</span>
                                <span class="badge bg-warning">Waiting for agent response...</span>
                            </div>
                        </div>
                        <div class="inline-reasoning-content">
                            <div class="text-center text-muted py-3">
                                <i class="fas fa-spinner fa-spin"></i>
                                <p class="mt-2">Waiting for AI agents to analyze the disruption...</p>
                            </div>
                        </div>
                    `;
                }
            }
        }
        
        function updateInlineReasoning(logId, streamId, event) {
            const reasoningContainer = document.getElementById(`reasoning-${logId}`);
            if (!reasoningContainer) {
                console.error(`Reasoning container not found for logId: ${logId}`);
                return;
            }
            
            // Make sure we have the event tracking data
            if (!eventReasoningStreams[logId]) {
                console.error(`No event stream tracking for logId: ${logId}`);
                return;
            }
            
            // Initialize reasoning display if first update
            if (!eventReasoningStreams[logId].reasoningStarted) {
                eventReasoningStreams[logId].reasoningStarted = true;
                eventReasoningStreams[logId].streamId = streamId;
                eventReasoningStreams[logId].content = '';
                
                const agentType = event.agentType || 'unknown';
                const agentIcon = agentType === 'crew_assignment' ? 'fa-users' : 'fa-headset';
                const agentName = agentType === 'crew_assignment' ? 'Crew Assignment Agent' : 'Operations Support Agent';
                
                console.log(`Initializing reasoning display for ${agentName}, streamId: ${streamId}`);
                
                reasoningContainer.innerHTML = `
                    <div class="inline-reasoning-header">
                        <div class="reasoning-stream-title">
                            <i class="fas ${agentIcon}"></i>
                            <span>${agentName}</span>
                            <span class="reasoning-confidence-indicator medium">
                                <i class="fas fa-brain"></i> Analyzing...
                            </span>
                        </div>
                        <span class="reasoning-typing-indicator">â–Š</span>
                    </div>
                    <div class="inline-reasoning-content" id="reasoning-content-${logId}"></div>
                `;
            }
            
            const contentEl = document.getElementById(`reasoning-content-${logId}`);
            if (!contentEl) {
                console.error(`Content element not found for reasoning-content-${logId}`);
                return;
            }
            
            console.log(`Processing event type: ${event.type} for logId: ${logId}`);
            
            if (event.type === 'reasoning_step') {
                // Add step indicator
                const stepDiv = document.createElement('div');
                stepDiv.className = 'reasoning-step-indicator';
                stepDiv.innerHTML = `<i class="fas fa-chevron-right"></i> ${event.content}`;
                contentEl.appendChild(stepDiv);
                
            } else if (event.type === 'token') {
                // Add token to content
                eventReasoningStreams[logId].content += event.content;
                
                // Parse and highlight content
                const highlightedContent = highlightReasoningContent(eventReasoningStreams[logId].content);
                contentEl.innerHTML = highlightedContent;
                
            } else if (event.type === 'reasoning_complete') {
                // Update header to show complete
                const header = reasoningContainer.querySelector('.inline-reasoning-header');
                if (header) {
                    const statusSpan = header.querySelector('.reasoning-confidence-indicator');
                    if (statusSpan) {
                        statusSpan.className = 'reasoning-confidence-indicator high';
                        statusSpan.innerHTML = '<i class="fas fa-check-circle"></i> Analysis Complete';
                    }
                    // Remove typing indicator
                    const typingIndicator = header.querySelector('.reasoning-typing-indicator');
                    if (typingIndicator) typingIndicator.remove();
                }
                
                // Add decision summary if available
                if (event.decision) {
                    const summaryDiv = document.createElement('div');
                    summaryDiv.className = 'alert alert-success mt-3';
                    summaryDiv.innerHTML = `<strong>Decision:</strong> ${event.decision}`;
                    contentEl.appendChild(summaryDiv);
                }
            }
            
            // Auto-scroll reasoning content
            contentEl.scrollTop = contentEl.scrollHeight;
        }

        function filterLogs(filterType) {
            const container = document.getElementById('operations-log');
            const entries = container.querySelectorAll('.log-entry');
            
            // Update button states
            document.querySelectorAll('.btn-group button').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            entries.forEach(entry => {
                if (filterType === 'all') {
                    entry.style.display = 'block';
                } else {
                    const entryType = entry.getAttribute('data-type');
                    if (filterType === 'disruptions' && entryType === 'disruption') {
                        entry.style.display = 'block';
                    } else if (filterType === 'crew_analysis' && entryType === 'crew_analysis') {
                        entry.style.display = 'block';
                    } else if (filterType === 'resolutions' && entryType === 'resolution') {
                        entry.style.display = 'block';
                    } else {
                        entry.style.display = 'none';
                    }
                }
            });
        }

        function toggleFullscreen() {
            const container = document.getElementById('operations-log');
            container.classList.toggle('fullscreen');
        }

        function refreshDashboard() {
            location.reload();
        }

        function showConfig() {
            fetch('/api/config')
                .then(response => response.json())
                .then(data => {
                    alert('System Configuration:\n' + JSON.stringify(data, null, 2));
                })
                .catch(error => {
                    addLog(`<i class="fas fa-cog text-danger"></i> Error loading config: ${error.message}`, 'error');
                });
        }

        async function checkSystemHealth() {
            try {
                const response = await fetch('/api/health');
                const data = await response.json();
                
                const statusElement = document.getElementById('system-status');
                if (data.status === 'healthy') {
                    statusElement.innerHTML = '<span class="badge bg-success">Healthy</span>';
                } else {
                    statusElement.innerHTML = '<span class="badge bg-danger">Unhealthy</span>';
                }
            } catch (error) {
                document.getElementById('system-status').innerHTML = '<span class="badge bg-danger">Error</span>';
            }
        }

        function startAutoRefresh() {
            refreshInterval = setInterval(() => {
                loadSimulations();
                checkSystemHealth();
            }, 10000); // Refresh every 10 seconds
        }

        // Agent response panel functions
        function showAgentResponsesPanel() {
            if (!currentSimulationId) {
                alert('No active simulation to show agent responses for.');
                return;
            }
            
            // Create modal for agent responses
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.id = 'agentResponsesModal';
            modal.innerHTML = `
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Agent Response Analysis</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="d-flex justify-content-between mb-3">
                                <div>
                                    <button class="btn btn-sm btn-outline-primary" onclick="loadAgentResponses('crew_assignment')">Crew Responses</button>
                                    <button class="btn btn-sm btn-outline-secondary" onclick="loadAgentResponses('ops_support')">Ops Responses</button>
                                    <button class="btn btn-sm btn-outline-dark" onclick="loadAgentResponses('')">All Responses</button>
                                </div>
                                <div>
                                    <button class="btn btn-sm btn-success" onclick="exportAgentResponses('json')">Export JSON</button>
                                    <button class="btn btn-sm btn-info" onclick="exportAgentResponses('csv')">Export CSV</button>
                                </div>
                            </div>
                            <div id="agentResponsesContent">
                                <div class="text-center text-muted py-4">
                                    <i class="fas fa-robot fa-2x"></i>
                                    <p>Loading agent responses...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
            
            // Load all responses by default
            loadAgentResponses('');
            
            // Clean up when modal is hidden
            modal.addEventListener('hidden.bs.modal', function() {
                document.body.removeChild(modal);
            });
        }
        
        async function loadAgentResponses(agentType = '') {
            if (!currentSimulationId) return;
            
            try {
                const url = `/api/simulation/${currentSimulationId}/agent-responses${agentType ? `?agent_type=${agentType}` : ''}`;
                const response = await fetch(url);
                const data = await response.json();
                
                const container = document.getElementById('agentResponsesContent');
                
                if (data.agent_responses.length === 0) {
                    container.innerHTML = `
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-info-circle"></i>
                            <p>No agent responses found for the selected filter.</p>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = data.agent_responses.map(response => `
                    <div class="card mb-3">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">
                                <i class="fas fa-${response.agent_type === 'crew_assignment' ? 'users' : 'hotel'}"></i>
                                ${response.agent_type === 'crew_assignment' ? 'Crew Assignment' : 'Operations Support'} - ${response.flight_id}
                                <span class="badge bg-${getConfidenceBadgeColor(response.confidence_level)} ms-2">${response.confidence_level} confidence</span>
                            </h6>
                            <small class="text-muted">${new Date(response.timestamp).toLocaleString()}</small>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-8">
                                    <h6>Reasoning:</h6>
                                    <p class="small">${response.reasoning}</p>
                                </div>
                                <div class="col-md-4">
                                    <h6>Analysis Details:</h6>
                                    <ul class="list-unstyled small">
                                        ${Object.entries(response.detailed_analysis || {}).map(([key, value]) => 
                                            `<li><strong>${key.replace(/_/g, ' ')}:</strong> ${Array.isArray(value) ? value.join(', ') : value}</li>`
                                        ).join('')}
                                    </ul>
                                    ${response.handoff_required ? `<div class="alert alert-info small"><strong>Handoff:</strong> ${response.handoff_context}</div>` : ''}
                                    ${response.booking_confirmed ? `<div class="alert alert-success small"><strong>Booking:</strong> Confirmed</div>` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('Error loading agent responses:', error);
                document.getElementById('agentResponsesContent').innerHTML = `
                    <div class="alert alert-danger">
                        Error loading agent responses: ${error.message}
                    </div>
                `;
            }
        }
        
        function getConfidenceBadgeColor(level) {
            switch(level) {
                case 'high': return 'success';
                case 'medium': return 'warning';
                case 'low': return 'danger';
                default: return 'secondary';
            }
        }
        
        function showEventDetails(eventId) {
            const event = detailedEvents[eventId];
            if (!event) {
                alert('Event details not found.');
                return;
            }
            
            // Create detailed event modal
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.innerHTML = `
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Event Details - ${event.flight_id}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <pre class="bg-light p-3 rounded">${JSON.stringify(event, null, 2)}</pre>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
            
            modal.addEventListener('hidden.bs.modal', function() {
                document.body.removeChild(modal);
            });
        }
        
        async function exportAgentResponses(format) {
            if (!currentSimulationId) return;
            
            try {
                const url = `/api/simulation/${currentSimulationId}/agent-responses/export?format=${format}`;
                const response = await fetch(url);
                
                if (response.ok) {
                    const blob = await response.blob();
                    const downloadUrl = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = downloadUrl;
                    a.download = `agent_responses_${currentSimulationId}.${format}`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(downloadUrl);
                } else {
                    alert('Error exporting agent responses');
                }
            } catch (error) {
                console.error('Export error:', error);
                alert('Error exporting agent responses');
            }
        }
        
        // Highlight important content in reasoning
        function highlightReasoningContent(content) {
            let highlighted = content;
            
            // Highlight tools
            highlighted = highlighted.replace(/Action: (\w+)/g, (match, tool) => {
                return `Action: <span class="reasoning-tool-usage">${tool}</span>`;
            });
            
            // Highlight crew violations
            highlighted = highlighted.replace(/(\d+\.?\d*)\s*hours?\s*below\s*minimum/gi, (match, hours) => {
                return `<span class="reasoning-highlight">${hours} hours below minimum</span>`;
            });
            
            // Highlight handoff decisions
            highlighted = highlighted.replace(/HANDOFF_TO_OPS/g, '<span class="reasoning-highlight">HANDOFF_TO_OPS</span>');
            
            // Highlight crew IDs
            highlighted = highlighted.replace(/([CS]\d{3})/g, '<span class="badge bg-secondary">$1</span>');
            
            // Highlight flight IDs
            highlighted = highlighted.replace(/(UA\d{3,4})/g, '<span class="badge bg-primary">$1</span>');
            
            // Add handoff indicator if detected
            if (highlighted.includes('HANDOFF_TO_OPS')) {
                const handoffDiv = document.createElement('div');
                handoffDiv.className = 'reasoning-handoff-indicator';
                handoffDiv.innerHTML = `
                    <i class="fas fa-exchange-alt"></i>
                    <span>Handoff to Operations Support Initiated</span>
                `;
                return highlighted + handoffDiv.outerHTML;
            }
            
            return highlighted;
        }
        


        // Handle page visibility changes
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                clearInterval(refreshInterval);
            } else {
                startAutoRefresh();
            }
        });
    </script>
</body>
</html>