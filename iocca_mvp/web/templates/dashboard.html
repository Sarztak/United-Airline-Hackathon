<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }} | United Airlines IOCCA Hub</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* United Airlines Typography */
        body { 
            background-color: #f8f9fa; 
            font-family: 'Helvetica Neue', 'Arial', sans-serif;
        }
        
        /* United Airlines Color Palette */
        :root {
            --united-blue: #004E9E;
            --united-dark-blue: #003366;
            --united-light-blue: #009CDE;
            --united-gold: #FFB700;
            --united-gray: #6C757D;
            --united-light-gray: #F8F9FA;
        }
        
        .card { 
            box-shadow: 0 0.125rem 0.25rem rgba(0, 78, 158, 0.1);
            border: 1px solid rgba(0, 78, 158, 0.1);
        }
        .status-badge { font-size: 0.875rem; }
        .agent-card { border-left: 4px solid var(--united-blue); }
        .logs-container {
            height: 70vh;
            overflow-y: auto;
            background: #f8f9fa;
            font-family: 'SF Mono', 'Monaco', 'Cascadia Code', 'Roboto Mono', monospace;
            font-size: 0.85rem;
            line-height: 1.4;
            border: 1px solid #e9ecef;
        }
        
        .logs-container.fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 9999;
            background: white;
            border: none;
        }
        
        .log-entry {
            padding: 0.5rem 1rem;
            border-bottom: 1px solid #e9ecef;
            margin: 0;
        }
        
        .log-entry.disruption { border-left: 4px solid #dc3545; }
        .log-entry.crew_analysis { border-left: 4px solid #0dcaf0; }
        .log-entry.resolution { border-left: 4px solid #198754; }
        .log-entry.normal { border-left: 4px solid #6c757d; }
        
        .log-entry:hover {
            background-color: #f8f9fa;
            cursor: pointer;
        }
        
        .agent-response-card {
            border-left: 4px solid var(--united-blue);
            transition: all 0.3s ease;
        }
        
        .agent-response-card:hover {
            box-shadow: 0 0.25rem 0.5rem rgba(0, 0, 0, 0.1);
            transform: translateY(-1px);
        }
        
        .confidence-high { color: #28a745; }
        .confidence-medium { color: #ffc107; }
        .confidence-low { color: #dc3545; }
        
        .log-timestamp {
            color: #6c757d;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .log-content {
            margin-top: 0.25rem;
            white-space: pre-wrap;
        }
        
        .metric-card { 
            text-align: center; 
            border-radius: 8px;
            transition: transform 0.2s ease-in-out;
        }
        
        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 78, 158, 0.15);
        }
        
        .processing { animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        
        /* United Airlines Section Headers */
        .card-header {
            background-color: var(--united-light-gray);
            border-bottom: 2px solid var(--united-blue);
            font-weight: 600;
        }
        
        .card-header h5 {
            color: var(--united-blue);
            margin-bottom: 0;
            font-weight: 700;
        }
        
        /* Enhanced Button Styling */
        .btn-outline-primary {
            border-color: var(--united-blue);
            color: var(--united-blue);
        }
        
        .btn-outline-primary:hover {
            background-color: var(--united-blue);
            border-color: var(--united-blue);
        }
        
        .btn-primary {
            background-color: var(--united-blue);
            border-color: var(--united-blue);
        }
        
        .btn-primary:hover {
            background-color: var(--united-dark-blue);
            border-color: var(--united-dark-blue);
        }
        
        /* Enhanced Reasoning Log Styles */
        .reasoning-log-container {
            height: 70vh;
            overflow-y: auto;
            background: #f8f9fa;
            border: 1px solid #e9ecef;
        }
        
        .reasoning-log-container.fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 9999;
            background: white;
            border: none;
        }
        
        .reasoning-step-card {
            margin: 0.5rem;
            border: 1px solid #e9ecef;
            border-radius: 0.5rem;
            background: white;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            transition: all 0.3s ease;
        }
        
        .reasoning-step-card:hover {
            box-shadow: 0 0.25rem 0.5rem rgba(0, 0, 0, 0.1);
            transform: translateY(-1px);
        }
        
        .reasoning-step-card.agent_chain { border-left: 4px solid var(--united-blue); }
        .reasoning-step-card.action { border-left: 4px solid #28a745; }
        .reasoning-step-card.observation { border-left: 4px solid #ffc107; }
        .reasoning-step-card.thought { border-left: 4px solid #6f42c1; }
        .reasoning-step-card.http_request { border-left: 4px solid #fd7e14; }
        .reasoning-step-card.final_answer { border-left: 4px solid #198754; }
        
        .reasoning-step-header {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #e9ecef;
            background-color: #f8f9fa;
            cursor: pointer;
        }
        
        .reasoning-step-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .reasoning-step-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .reasoning-step-badge.agent_chain { background-color: var(--united-blue); color: white; }
        .reasoning-step-badge.action { background-color: #28a745; color: white; }
        .reasoning-step-badge.observation { background-color: #ffc107; color: black; }
        .reasoning-step-badge.thought { background-color: #6f42c1; color: white; }
        .reasoning-step-badge.http_request { background-color: #fd7e14; color: white; }
        .reasoning-step-badge.final_answer { background-color: #198754; color: white; }
        
        .reasoning-step-meta {
            font-size: 0.75rem;
            color: #6c757d;
            margin-top: 0.25rem;
        }
        
        .reasoning-step-content {
            padding: 1rem;
            display: none;
        }
        
        .reasoning-step-content.expanded {
            display: block;
        }
        
        .reasoning-content-text {
            font-family: 'SF Mono', 'Monaco', 'Cascadia Code', 'Roboto Mono', monospace;
            font-size: 0.85rem;
            line-height: 1.4;
            white-space: pre-wrap;
            background-color: #f8f9fa;
            padding: 0.75rem;
            border-radius: 0.25rem;
            border: 1px solid #e9ecef;
        }
        
        .reasoning-metadata-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 0.5rem;
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid #e9ecef;
        }
        
        .reasoning-metadata-item {
            font-size: 0.75rem;
        }
        
        .reasoning-metadata-item strong {
            color: var(--united-blue);
            display: block;
            margin-bottom: 0.125rem;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light" style="background-color: #ffffff; border-bottom: 3px solid var(--united-blue); box-shadow: 0 2px 4px rgba(0,78,158,0.1);"
        <div class="container">
            <a class="navbar-brand d-flex align-items-center" href="/" style="color: var(--united-blue); font-weight: 600; text-decoration: none;"
                <img src="https://www.logo.wine/a/logo/United_Airlines/United_Airlines-Logo.wine.svg" alt="United Airlines" height="36" class="me-3" style="filter: none; background: white; padding: 2px;">
                <span style="font-size: 1.5rem; color: var(--united-blue); font-weight: 700;">IOCCA Hub</span>
            </a>
            <span class="navbar-text" style="color: var(--united-blue); font-weight: 500;"
                Day Simulation - Crew Operations Management
            </span>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Status Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="fas fa-play" style="color: var(--united-blue);"></i>
                        </h5>
                        <h3 id="active-simulations" style="color: var(--united-blue); font-weight: 700;">{{ active_simulations }}</h3>
                        <p class="text-muted">Active Simulations</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="fas fa-calendar-day" style="color: var(--united-gold);"></i>
                        </h5>
                        <h3 id="total-simulations" style="color: var(--united-blue); font-weight: 700;">{{ total_simulations }}</h3>
                        <p class="text-muted">Total Simulations</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="fas fa-users" style="color: var(--united-light-blue);"></i>
                        </h5>
                        <h3 id="agents-online" style="color: var(--united-blue); font-weight: 700;">3</h3>
                        <p class="text-muted">Agents Online</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="fas fa-heartbeat" style="color: var(--united-light-blue);"></i>
                        </h5>
                        <h3 id="system-status">
                            <span class="badge bg-success">Healthy</span>
                        </h3>
                        <p class="text-muted">System Status</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Control Panel -->
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-control"></i> Control Panel</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <p class="text-muted mb-3">Experience a full day of airline operations with realistic crew disruptions, agent reasoning, and automated resolutions.</p>
                        </div>
                        
                        <button id="start-day-simulation" class="btn btn-lg w-100 mb-3" style="background-color: var(--united-blue); border-color: var(--united-blue); color: white; font-weight: 600;"
                            <i class="fas fa-calendar-day"></i> Start Day Simulation
                        </button>
                        
                        <div class="d-grid gap-2">
                            <button class="btn" onclick="refreshDashboard()" style="border-color: var(--united-blue); color: var(--united-blue);"
                                <i class="fas fa-sync"></i> Refresh Dashboard
                            </button>
                            <button class="btn" onclick="showConfig()" style="border-color: var(--united-light-blue); color: var(--united-light-blue);"
                                <i class="fas fa-cog"></i> System Config
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Simulation Status -->
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5><i class="fas fa-calendar-day"></i> Day Simulation Status</h5>
                        <button class="btn btn-sm btn-outline-primary" onclick="loadSimulations()" style="border-color: var(--united-blue); color: var(--united-blue);">
                            <i class="fas fa-sync"></i>
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="simulations-list">
                            <div class="text-center text-muted py-4">
                                <i class="fas fa-info-circle"></i>
                                <p>No simulations running. Click "Start Day Simulation" to begin.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Live Operations Log -->
                <div class="card mt-3">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5><i class="fas fa-clipboard-list"></i> Operations Log</h5>
                        <div class="btn-group btn-group-sm" role="group">
                            <button type="button" class="btn btn-outline-secondary active" onclick="filterLogs('all')">All</button>
                            <button type="button" class="btn btn-outline-warning" onclick="filterLogs('disruptions')">Disruptions</button>
                            <button type="button" class="btn btn-outline-info" onclick="filterLogs('crew_analysis')">Crew Analysis</button>
                            <button type="button" class="btn btn-outline-success" onclick="filterLogs('resolutions')">Resolutions</button>
                            <button type="button" class="btn btn-outline-dark" onclick="showAgentResponsesPanel()">
                                <i class="fas fa-robot"></i> Agent Details
                            </button>
                            <button type="button" class="btn btn-outline-primary" onclick="toggleFullscreen()">
                                <i class="fas fa-expand"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div id="operations-log" class="logs-container">
                            <div class="text-center text-muted py-4">
                                <i class="fas fa-info-circle"></i>
                                <p>Operations log will appear here...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Model Reasoning Log -->
                <div class="card mt-3">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5><i class="fas fa-brain"></i> Model Reasoning Log</h5>
                        <div class="btn-group btn-group-sm" role="group">
                            <button type="button" class="btn btn-outline-secondary active" onclick="filterReasoningLogs('all')">All</button>
                            <button type="button" class="btn btn-outline-info" onclick="filterReasoningLogs('agent_chain')">Agent Chains</button>
                            <button type="button" class="btn btn-outline-primary" onclick="filterReasoningLogs('actions')">Actions</button>
                            <button type="button" class="btn btn-outline-success" onclick="filterReasoningLogs('thoughts')">Thoughts</button>
                            <button type="button" class="btn btn-outline-warning" onclick="filterReasoningLogs('http_requests')">HTTP</button>
                            <button type="button" class="btn btn-outline-dark" onclick="showReasoningDetailsPanel()">
                                <i class="fas fa-eye"></i> Details
                            </button>
                            <button type="button" class="btn btn-outline-danger" onclick="clearReasoningLog()">
                                <i class="fas fa-trash"></i> Clear
                            </button>
                            <button type="button" class="btn btn-outline-primary" onclick="toggleReasoningFullscreen()">
                                <i class="fas fa-expand"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div id="reasoning-log" class="reasoning-log-container">
                            <div class="text-center text-muted py-4">
                                <i class="fas fa-brain"></i>
                                <p>Model reasoning log will appear here...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global variables
        let refreshInterval;
        let currentSimulationId = null;
        let websocket = null;

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            checkSystemHealth();
            loadSimulations();
            startAutoRefresh();
            connectWebSocket();
        });

        // Start day simulation
        document.getElementById('start-day-simulation').addEventListener('click', async function() {
            const button = this;
            
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Starting...';

            try {
                const response = await fetch('/api/simulation/start-day', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    currentSimulationId = result.simulation_id;
                    addLog(`<i class="fas fa-play-circle text-primary"></i> Day simulation started: ${result.simulation_id}`, 'info');
                    loadSimulations();
                    monitorSimulation(result.simulation_id);
                } else {
                    addLog(`<i class="fas fa-exclamation-circle text-danger"></i> Error: ${result.detail}`, 'error');
                }
            } catch (error) {
                addLog(`<i class="fas fa-exclamation-circle text-danger"></i> Error: ${error.message}`, 'error');
            } finally {
                button.disabled = false;
                button.innerHTML = '<i class="fas fa-calendar-day"></i> Start Day Simulation';
            }
        });

        // WebSocket handling
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws`;
            
            websocket = new WebSocket(wsUrl);
            
            websocket.onopen = function(event) {
                console.log('WebSocket connected');
                addLog('<i class="fas fa-wifi text-success"></i> Real-time monitoring connected', 'info');
            };
            
            websocket.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    handleWebSocketMessage(data);
                } catch (error) {
                    console.error('Error parsing WebSocket message:', error);
                }
            };
            
            websocket.onclose = function(event) {
                console.log('WebSocket disconnected');
                addLog('<i class="fas fa-wifi text-warning"></i> Real-time monitoring disconnected', 'warning');
                setTimeout(connectWebSocket, 5000);
            };
            
            websocket.onerror = function(error) {
                console.error('WebSocket error:', error);
                addLog('<i class="fas fa-exclamation-triangle text-danger"></i> WebSocket connection error', 'error');
            };
        }

        // Handle WebSocket messages
        function handleWebSocketMessage(data) {
            if (data.type === 'simulation_event') {
                handleSimulationEvent(data);
            } else if (data.type === 'simulation_complete') {
                handleSimulationComplete(data);
            } else if (data.type === 'simulation_error') {
                handleSimulationError(data);
            }
        }

        // Handle simulation events
        function handleSimulationEvent(data) {
            const event = data.event;
            let logMessage = '';
            let logType = 'info';
            
            switch (event.type) {
                case 'time_update':
                    logMessage = `Time Update: ${event.message}`;
                    logType = 'info';
                    break;
                case 'normal_operation':
                    logMessage = `<i class="fas fa-check-circle text-success"></i> ${event.flight_id} departed on time from ${event.origin} to ${event.destination}`;
                    logType = 'success';
                    break;
                case 'disruption_detected':
                    logMessage = `<i class="fas fa-exclamation-triangle text-warning"></i> DISRUPTION: ${event.flight_id} - ${event.description}`;
                    logType = 'disruption';
                    break;
                case 'crew_analysis':
                    logMessage = `<i class="fas fa-users text-info"></i> CREW ANALYSIS: ${event.flight_id} - ${event.reasoning.substring(0, 100)}...`;
                    logType = 'crew_analysis';
                    // Store full event data for detailed view
                    storeEventForDetails(event);
                    break;
                case 'ops_support':
                    logMessage = `<i class="fas fa-headset text-primary"></i> OPS SUPPORT: ${event.flight_id} - ${event.reasoning.substring(0, 100)}...`;
                    logType = 'crew_analysis';
                    // Store full event data for detailed view
                    storeEventForDetails(event);
                    break;
                case 'disruption_resolved':
                    logMessage = `<i class="fas fa-check-circle text-success"></i> RESOLVED: ${event.flight_id} - ${event.resolution}`;
                    logType = 'resolution';
                    break;
                case 'llm_crew_reasoning':
                    if (event.llm_event && event.llm_event.type === 'token') {
                        return;
                    }
                    logMessage = `<i class="fas fa-robot text-info"></i> CREW LLM: ${event.flight_id} - Live reasoning in progress`;
                    logType = 'crew_analysis';
                    break;
                case 'llm_ops_reasoning':
                    if (event.llm_event && event.llm_event.type === 'token') {
                        return;
                    }
                    logMessage = `<i class="fas fa-robot text-primary"></i> OPS LLM: ${event.flight_id} - Live reasoning in progress`;
                    logType = 'crew_analysis';
                    break;
                default:
                    logMessage = `<i class="fas fa-clipboard-list"></i> ${event.type}: ${JSON.stringify(event)}`;
                    logType = 'info';
            }
            
            addLog(logMessage, logType, event);
            loadSimulations();
        }

        // Handle simulation completion
        function handleSimulationComplete(data) {
            addLog(`<i class="fas fa-trophy text-success"></i> Day simulation completed: ${data.simulation_id}`, 'success');
            currentSimulationId = null;
            loadSimulations();
        }

        // Handle simulation error
        function handleSimulationError(data) {
            addLog(`<i class="fas fa-exclamation-circle text-danger"></i> Simulation error: ${data.error}`, 'error');
            currentSimulationId = null;
            loadSimulations();
        }

        // Monitor simulation status
        async function monitorSimulation(simulationId) {
            while (currentSimulationId === simulationId) {
                try {
                    const response = await fetch(`/api/simulation/${simulationId}`);
                    const data = await response.json();
                    
                    if (data.status === 'completed') {
                        addLog(`<i class="fas fa-check-circle text-success"></i> Simulation ${simulationId} completed successfully`, 'success');
                        loadSimulations();
                        currentSimulationId = null;
                        break;
                    } else if (data.status === 'failed') {
                        addLog(`<i class="fas fa-times-circle text-danger"></i> Simulation ${simulationId} failed: ${data.error}`, 'error');
                        loadSimulations();
                        currentSimulationId = null;
                        break;
                    }
                    
                    await new Promise(resolve => setTimeout(resolve, 2000));
                } catch (error) {
                    addLog(`<i class="fas fa-exclamation-triangle text-warning"></i> Error monitoring simulation: ${error.message}`, 'error');
                    break;
                }
            }
        }

        // Load simulations
        async function loadSimulations() {
            try {
                const response = await fetch('/api/simulations');
                const data = await response.json();
                
                const container = document.getElementById('simulations-list');
                
                if (data.simulations.length === 0) {
                    container.innerHTML = `
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-info-circle"></i>
                            <p>No simulations running. Click "Start Day Simulation" to begin.</p>
                        </div>
                    `;
                } else {
                    container.innerHTML = data.simulations.map(simulation => `
                        <div class="border rounded p-3 mb-2">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h6 class="mb-1">Simulation ${simulation.simulation_id.substring(0, 8)}</h6>
                                    <p class="text-muted mb-1">${simulation.type || 'Day Simulation'}</p>
                                    <small class="text-muted">${new Date(simulation.start_time).toLocaleString()}</small>
                                </div>
                                <span class="badge bg-${getStatusColor(simulation.status)} ${simulation.status === 'running' ? 'processing' : ''}">
                                    ${simulation.status}
                                </span>
                            </div>
                            ${simulation.end_time ? `
                                <div class="mt-2 pt-2 border-top">
                                    <small><strong>Completed:</strong> ${new Date(simulation.end_time).toLocaleString()}</small>
                                </div>
                            ` : ''}
                        </div>
                    `).join('');
                }
                
                // Update metrics
                document.getElementById('active-simulations').textContent = data.active;
                document.getElementById('total-simulations').textContent = data.total;
                
            } catch (error) {
                console.error('Error loading simulations:', error);
                addLog(`<i class="fas fa-exclamation-triangle text-danger"></i> Error loading simulations: ${error.message}`, 'error');
            }
        }

        // Utility functions
        function getStatusColor(status) {
            switch (status) {
                case 'running': return 'primary';
                case 'completed': return 'success';
                case 'failed': return 'danger';
                case 'processing': return 'warning';
                default: return 'secondary';
            }
        }

        // Global storage for detailed event data
        let detailedEvents = {};
        
        function storeEventForDetails(event) {
            const eventId = `${event.type}_${event.flight_id || 'unknown'}_${event.sim_time || Date.now()}`;
            detailedEvents[eventId] = event;
        }
        
        function addLog(message, type, eventData = null) {
            const container = document.getElementById('operations-log');
            const timestamp = new Date().toLocaleTimeString();
            
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            logEntry.setAttribute('data-type', type);
            
            let expandButton = '';
            if (eventData && (eventData.type === 'crew_analysis' || eventData.type === 'ops_support')) {
                const eventId = `${eventData.type}_${eventData.flight_id || 'unknown'}_${eventData.sim_time || Date.now()}`;
                expandButton = `<button class="btn btn-sm btn-outline-info ms-2" onclick="showEventDetails('${eventId}')">
                    <i class="fas fa-expand-alt"></i> Details
                </button>`;
            }
            
            logEntry.innerHTML = `
                <div class="log-timestamp">${timestamp}</div>
                <div class="log-content">
                    ${message}
                    ${expandButton}
                </div>
            `;
            
            container.appendChild(logEntry);
            container.scrollTop = container.scrollHeight;
            
            // Keep only last 100 log entries
            while (container.children.length > 100) {
                container.removeChild(container.firstChild);
            }
        }

        function filterLogs(filterType) {
            const container = document.getElementById('operations-log');
            const entries = container.querySelectorAll('.log-entry');
            
            // Update button states
            document.querySelectorAll('.btn-group button').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            entries.forEach(entry => {
                if (filterType === 'all') {
                    entry.style.display = 'block';
                } else {
                    const entryType = entry.getAttribute('data-type');
                    if (filterType === 'disruptions' && entryType === 'disruption') {
                        entry.style.display = 'block';
                    } else if (filterType === 'crew_analysis' && entryType === 'crew_analysis') {
                        entry.style.display = 'block';
                    } else if (filterType === 'resolutions' && entryType === 'resolution') {
                        entry.style.display = 'block';
                    } else {
                        entry.style.display = 'none';
                    }
                }
            });
        }

        function toggleFullscreen() {
            const container = document.getElementById('operations-log');
            container.classList.toggle('fullscreen');
        }

        function refreshDashboard() {
            location.reload();
        }

        function showConfig() {
            fetch('/api/config')
                .then(response => response.json())
                .then(data => {
                    alert('System Configuration:\n' + JSON.stringify(data, null, 2));
                })
                .catch(error => {
                    addLog(`<i class="fas fa-cog text-danger"></i> Error loading config: ${error.message}`, 'error');
                });
        }

        async function checkSystemHealth() {
            try {
                const response = await fetch('/api/health');
                const data = await response.json();
                
                const statusElement = document.getElementById('system-status');
                if (data.status === 'healthy') {
                    statusElement.innerHTML = '<span class="badge bg-success">Healthy</span>';
                } else {
                    statusElement.innerHTML = '<span class="badge bg-danger">Unhealthy</span>';
                }
            } catch (error) {
                document.getElementById('system-status').innerHTML = '<span class="badge bg-danger">Error</span>';
            }
        }

        function startAutoRefresh() {
            refreshInterval = setInterval(() => {
                loadSimulations();
                checkSystemHealth();
            }, 10000); // Refresh every 10 seconds
        }

        // Agent response panel functions
        function showAgentResponsesPanel() {
            if (!currentSimulationId) {
                alert('No active simulation to show agent responses for.');
                return;
            }
            
            // Create modal for agent responses
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.id = 'agentResponsesModal';
            modal.innerHTML = `
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Agent Response Analysis</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="d-flex justify-content-between mb-3">
                                <div>
                                    <button class="btn btn-sm btn-outline-primary" onclick="loadAgentResponses('crew_assignment')">Crew Responses</button>
                                    <button class="btn btn-sm btn-outline-secondary" onclick="loadAgentResponses('ops_support')">Ops Responses</button>
                                    <button class="btn btn-sm btn-outline-dark" onclick="loadAgentResponses('')">All Responses</button>
                                </div>
                                <div>
                                    <button class="btn btn-sm btn-success" onclick="exportAgentResponses('json')">Export JSON</button>
                                    <button class="btn btn-sm btn-info" onclick="exportAgentResponses('csv')">Export CSV</button>
                                </div>
                            </div>
                            <div id="agentResponsesContent">
                                <div class="text-center text-muted py-4">
                                    <i class="fas fa-robot fa-2x"></i>
                                    <p>Loading agent responses...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
            
            // Load all responses by default
            loadAgentResponses('');
            
            // Clean up when modal is hidden
            modal.addEventListener('hidden.bs.modal', function() {
                document.body.removeChild(modal);
            });
        }
        
        async function loadAgentResponses(agentType = '') {
            if (!currentSimulationId) return;
            
            try {
                const url = `/api/simulation/${currentSimulationId}/agent-responses${agentType ? `?agent_type=${agentType}` : ''}`;
                const response = await fetch(url);
                const data = await response.json();
                
                const container = document.getElementById('agentResponsesContent');
                
                if (data.agent_responses.length === 0) {
                    container.innerHTML = `
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-info-circle"></i>
                            <p>No agent responses found for the selected filter.</p>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = data.agent_responses.map(response => `
                    <div class="card mb-3">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">
                                <i class="fas fa-${response.agent_type === 'crew_assignment' ? 'users' : 'hotel'}"></i>
                                ${response.agent_type === 'crew_assignment' ? 'Crew Assignment' : 'Operations Support'} - ${response.flight_id}
                                <span class="badge bg-${getConfidenceBadgeColor(response.confidence_level)} ms-2">${response.confidence_level} confidence</span>
                            </h6>
                            <small class="text-muted">${new Date(response.timestamp).toLocaleString()}</small>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-8">
                                    <h6>Reasoning:</h6>
                                    <p class="small">${response.reasoning}</p>
                                </div>
                                <div class="col-md-4">
                                    <h6>Analysis Details:</h6>
                                    <ul class="list-unstyled small">
                                        ${Object.entries(response.detailed_analysis || {}).map(([key, value]) => 
                                            `<li><strong>${key.replace(/_/g, ' ')}:</strong> ${Array.isArray(value) ? value.join(', ') : value}</li>`
                                        ).join('')}
                                    </ul>
                                    ${response.handoff_required ? `<div class="alert alert-info small"><strong>Handoff:</strong> ${response.handoff_context}</div>` : ''}
                                    ${response.booking_confirmed ? `<div class="alert alert-success small"><strong>Booking:</strong> Confirmed</div>` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('Error loading agent responses:', error);
                document.getElementById('agentResponsesContent').innerHTML = `
                    <div class="alert alert-danger">
                        Error loading agent responses: ${error.message}
                    </div>
                `;
            }
        }
        
        function getConfidenceBadgeColor(level) {
            switch(level) {
                case 'high': return 'success';
                case 'medium': return 'warning';
                case 'low': return 'danger';
                default: return 'secondary';
            }
        }
        
        function showEventDetails(eventId) {
            const event = detailedEvents[eventId];
            if (!event) {
                alert('Event details not found.');
                return;
            }
            
            // Create detailed event modal
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.innerHTML = `
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Event Details - ${event.flight_id}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <pre class="bg-light p-3 rounded">${JSON.stringify(event, null, 2)}</pre>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
            
            modal.addEventListener('hidden.bs.modal', function() {
                document.body.removeChild(modal);
            });
        }
        
        async function exportAgentResponses(format) {
            if (!currentSimulationId) return;
            
            try {
                const url = `/api/simulation/${currentSimulationId}/agent-responses/export?format=${format}`;
                const response = await fetch(url);
                
                if (response.ok) {
                    const blob = await response.blob();
                    const downloadUrl = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = downloadUrl;
                    a.download = `agent_responses_${currentSimulationId}.${format}`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(downloadUrl);
                } else {
                    alert('Error exporting agent responses');
                }
            } catch (error) {
                console.error('Export error:', error);
                alert('Error exporting agent responses');
            }
        }
        
        // Enhanced Reasoning Log Functions
        let reasoningStepCounter = 0;
        
        function addReasoningLog(content, type, metadata = {}, confidence = 'medium') {
            const container = document.getElementById('reasoning-log');
            const timestamp = new Date().toLocaleTimeString();
            const stepId = `reasoning-step-${++reasoningStepCounter}`;
            
            // Remove placeholder if it exists
            const placeholder = container.querySelector('.text-center');
            if (placeholder) {
                placeholder.remove();
            }
            
            const reasoningCard = document.createElement('div');
            reasoningCard.className = `reasoning-step-card ${type}`;
            reasoningCard.setAttribute('data-type', type);
            reasoningCard.setAttribute('data-step-id', stepId);
            
            // Create metadata grid HTML
            let metadataHtml = '';
            if (Object.keys(metadata).length > 0) {
                metadataHtml = `
                    <div class="reasoning-metadata-grid">
                        ${Object.entries(metadata).map(([key, value]) => `
                            <div class="reasoning-metadata-item">
                                <strong>${key.replace(/_/g, ' ').toUpperCase()}</strong>
                                <span>${value}</span>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            // Get appropriate icon for type
            const typeIcons = {
                'agent_chain': 'fas fa-link',
                'action': 'fas fa-play-circle',
                'observation': 'fas fa-eye',
                'thought': 'fas fa-brain',
                'http_request': 'fas fa-globe',
                'final_answer': 'fas fa-check-circle'
            };
            
            const icon = typeIcons[type] || 'fas fa-question-circle';
            const displayType = type.replace(/_/g, ' ').toUpperCase();
            
            reasoningCard.innerHTML = `
                <div class="reasoning-step-header" onclick="toggleReasoningStep('${stepId}')">
                    <div class="reasoning-step-title">
                        <div>
                            <i class="${icon}"></i>
                            <span class="ms-2">${displayType}</span>
                            <span class="reasoning-step-badge ${type} ms-2">${displayType}</span>
                        </div>
                        <div>
                            <i class="fas fa-chevron-down" id="chevron-${stepId}"></i>
                        </div>
                    </div>
                    <div class="reasoning-step-meta">
                        <span><i class="fas fa-clock"></i> ${timestamp}</span>
                        <span class="ms-3"><i class="fas fa-star"></i> ${confidence.toUpperCase()} confidence</span>
                        ${metadata.flight_id ? `<span class="ms-3"><i class="fas fa-plane"></i> ${metadata.flight_id}</span>` : ''}
                    </div>
                </div>
                <div class="reasoning-step-content" id="content-${stepId}">
                    <div class="reasoning-content-text">${content}</div>
                    ${metadataHtml}
                </div>
            `;
            
            container.appendChild(reasoningCard);
            container.scrollTop = container.scrollHeight;
            
            // Keep only last 50 reasoning entries for performance
            while (container.children.length > 50) {
                container.removeChild(container.firstChild);
            }
        }
        
        function toggleReasoningStep(stepId) {
            const content = document.getElementById(`content-${stepId}`);
            const chevron = document.getElementById(`chevron-${stepId}`);
            
            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                chevron.classList.remove('fa-chevron-up');
                chevron.classList.add('fa-chevron-down');
            } else {
                content.classList.add('expanded');
                chevron.classList.remove('fa-chevron-down');
                chevron.classList.add('fa-chevron-up');
            }
        }
        
        function parseAndAddReasoningLog(logData) {
            // Parse different types of log entries based on the example provided
            const logText = typeof logData === 'string' ? logData : JSON.stringify(logData);
            
            // Detect different patterns in the log
            if (logText.includes('Entering new AgentExecutor chain')) {
                addReasoningLog('Agent execution chain has been initiated. Beginning structured problem-solving process.', 'agent_chain', {
                    'chain_type': 'AgentExecutor',
                    'status': 'started'
                }, 'high');
            } else if (logText.includes('Finished chain')) {
                addReasoningLog('Agent execution chain has completed successfully. All reasoning steps processed.', 'agent_chain', {
                    'chain_type': 'AgentExecutor',
                    'status': 'completed'
                }, 'high');
            } else if (logText.includes('HTTP Request:')) {
                const match = logText.match(/HTTP Request: (POST|GET|PUT|DELETE) (.*?) "HTTP\/1\.1 (\d+) (\w+)"/);
                if (match) {
                    const [, method, url, status, statusText] = match;
                    const confidence = status.startsWith('2') ? 'high' : status.startsWith('4') ? 'low' : 'medium';
                    addReasoningLog(`API call executed to external service.\n\nEndpoint: ${url}\nMethod: ${method}\nResponse: ${status} ${statusText}`, 'http_request', {
                        'status_code': `${status} ${statusText}`,
                        'method': method,
                        'endpoint': url.split('/').pop(),
                        'service': url.includes('openai') ? 'OpenAI API' : 'External API'
                    }, confidence);
                }
            } else if (logText.includes('Action:')) {
                const actionMatch = logText.match(/Action: (.*?)(?=\n|$)/);
                const inputMatch = logText.match(/Action Input: (.*?)(?=\n|$)/s);
                if (actionMatch) {
                    let actionContent = `Action: ${actionMatch[1]}`;
                    let metadata = { 'action_type': actionMatch[1] };
                    
                    if (inputMatch) {
                        actionContent += `\n\nInput Parameters:\n${inputMatch[1]}`;
                        try {
                            const inputObj = JSON.parse(inputMatch[1]);
                            if (inputObj.flight_id) metadata.flight_id = inputObj.flight_id;
                            if (inputObj.location) metadata.location = inputObj.location;
                        } catch (e) {
                            // Input is not JSON, that's fine
                        }
                    }
                    
                    addReasoningLog(actionContent, 'action', metadata, 'high');
                }
            } else if (logText.includes('Observation:')) {
                const obsMatch = logText.match(/Observation: (.*?)(?=\n|$)/s);
                if (obsMatch) {
                    let obsText = obsMatch[1];
                    let metadata = {};
                    
                    // Try to parse JSON observation
                    try {
                        const obsObj = JSON.parse(obsText);
                        if (obsObj.message) {
                            obsText = `Result: ${obsObj.message}\n\nRaw Data:\n${JSON.stringify(obsObj, null, 2)}`;
                        }
                        if (obsObj.legal_crew !== undefined) metadata.crew_status = 'analyzed';
                        if (obsObj.spare_crew) metadata.spare_crew_found = 'yes';
                    } catch (e) {
                        // Not JSON, use as-is
                    }
                    
                    addReasoningLog(obsText, 'observation', metadata, 'high');
                }
            } else if (logText.includes('Thought:')) {
                const thoughtMatch = logText.match(/Thought:(.*?)(?=Action:|Final Answer:|$)/s);
                if (thoughtMatch) {
                    const thoughtText = thoughtMatch[1].trim();
                    const metadata = {};
                    
                    // Extract key insights from thought
                    if (thoughtText.includes('crew members')) metadata.focus = 'crew_analysis';
                    if (thoughtText.includes('illegal') || thoughtText.includes('legal')) metadata.compliance_check = 'performed';
                    if (thoughtText.includes('rest period')) metadata.rest_analysis = 'performed';
                    
                    addReasoningLog(thoughtText, 'thought', metadata, 'medium');
                }
            } else if (logText.includes('Final Answer:')) {
                const answerMatch = logText.match(/Final Answer:(.*?)$/s);
                if (answerMatch) {
                    const answerText = answerMatch[1].trim();
                    const metadata = { 'completion_status': 'success' };
                    
                    // Extract key results
                    if (answerText.includes('HANDOFF_TO_OPS')) metadata.handoff_required = 'yes';
                    if (answerText.includes('accommodation')) metadata.accommodation_needed = 'yes';
                    
                    addReasoningLog(answerText, 'final_answer', metadata, 'high');
                }
            } else if (logText.includes('timestamp') && logText.includes('level')) {
                // Handle structured log entries
                try {
                    const parsed = JSON.parse(logText);
                    const metadata = {
                        'log_level': parsed.level,
                        'logger_name': parsed.logger,
                        'module': parsed.module || 'unknown',
                        'timestamp': parsed.timestamp
                    };
                    
                    addReasoningLog(parsed.message || 'System log entry', 'http_request', metadata, 'medium');
                } catch (e) {
                    // Fallback for malformed JSON
                    addReasoningLog(logText.substring(0, 200) + '...', 'thought', {}, 'low');
                }
            }
        }
        
        function filterReasoningLogs(filterType) {
            const container = document.getElementById('reasoning-log');
            const entries = container.querySelectorAll('.reasoning-step-card');
            
            // Update button states
            const reasoningButtons = document.querySelectorAll('.card:last-child .btn-group button');
            reasoningButtons.forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent.toLowerCase().includes(filterType) || 
                    (filterType === 'all' && btn.textContent === 'All') ||
                    (filterType === 'http_requests' && btn.textContent === 'HTTP')) {
                    btn.classList.add('active');
                }
            });
            
            entries.forEach(entry => {
                if (filterType === 'all') {
                    entry.style.display = 'block';
                } else {
                    const entryType = entry.getAttribute('data-type');
                    if (filterType === 'agent_chain' && entryType === 'agent_chain') {
                        entry.style.display = 'block';
                    } else if (filterType === 'actions' && entryType === 'action') {
                        entry.style.display = 'block';
                    } else if (filterType === 'thoughts' && entryType === 'thought') {
                        entry.style.display = 'block';
                    } else if (filterType === 'http_requests' && entryType === 'http_request') {
                        entry.style.display = 'block';
                    } else {
                        entry.style.display = 'none';
                    }
                }
            });
        }
        
        function clearReasoningLog() {
            const container = document.getElementById('reasoning-log');
            reasoningStepCounter = 0;
            container.innerHTML = `
                <div class="text-center text-muted py-4">
                    <i class="fas fa-brain"></i>
                    <p>Model reasoning log will appear here...</p>
                </div>
            `;
        }
        
        function toggleReasoningFullscreen() {
            const container = document.getElementById('reasoning-log');
            container.classList.toggle('fullscreen');
        }
        
        function showReasoningDetailsPanel() {
            const container = document.getElementById('reasoning-log');
            const entries = container.querySelectorAll('.reasoning-step-card');
            
            if (entries.length === 0) {
                alert('No reasoning steps to show details for.');
                return;
            }
            
            // Create modal for reasoning details
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.id = 'reasoningDetailsModal';
            modal.innerHTML = `
                <div class="modal-dialog modal-xl">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title"><i class="fas fa-brain"></i> Detailed Reasoning Analysis</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="d-flex justify-content-between mb-3">
                                <div>
                                    <button class="btn btn-sm btn-outline-primary" onclick="expandAllReasoningSteps()">Expand All</button>
                                    <button class="btn btn-sm btn-outline-secondary" onclick="collapseAllReasoningSteps()">Collapse All</button>
                                </div>
                                <div>
                                    <span class="badge bg-primary">${entries.length} reasoning steps</span>
                                </div>
                            </div>
                            <div id="reasoningDetailsContent" style="max-height: 70vh; overflow-y: auto;">
                                ${Array.from(entries).map(entry => entry.outerHTML).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
            
            // Clean up when modal is hidden
            modal.addEventListener('hidden.bs.modal', function() {
                document.body.removeChild(modal);
            });
        }
        
        function expandAllReasoningSteps() {
            const contents = document.querySelectorAll('#reasoningDetailsModal .reasoning-step-content');
            const chevrons = document.querySelectorAll('#reasoningDetailsModal .fa-chevron-down, #reasoningDetailsModal .fa-chevron-up');
            
            contents.forEach(content => content.classList.add('expanded'));
            chevrons.forEach(chevron => {
                chevron.classList.remove('fa-chevron-down');
                chevron.classList.add('fa-chevron-up');
            });
        }
        
        function collapseAllReasoningSteps() {
            const contents = document.querySelectorAll('#reasoningDetailsModal .reasoning-step-content');
            const chevrons = document.querySelectorAll('#reasoningDetailsModal .fa-chevron-down, #reasoningDetailsModal .fa-chevron-up');
            
            contents.forEach(content => content.classList.remove('expanded'));
            chevrons.forEach(chevron => {
                chevron.classList.remove('fa-chevron-up');
                chevron.classList.add('fa-chevron-down');
            });
        }
        
        // Demo function to show sample reasoning data (remove in production)
        function loadSampleReasoningData() {
            const sampleLogs = [
                'Entering new AgentExecutor chain...',
                '{"timestamp": "2025-06-22T03:46:26.060078", "level": "INFO", "logger": "httpx", "message": "HTTP Request: POST https://api.openai.com/v1/chat/completions \\"HTTP/1.1 200 OK\\"", "module": "_client", "function": "_send_single_request", "line": 1026}',
                'I need to analyze the flight disruption for Flight ID UA1011 and follow the required steps to check crew duty time legality, find spare crew if necessary, and assess accommodation needs.\n\nAction: check_crew_legality\nAction Input: {"flight_id": "UA1011"}',
                'Observation: {"legal_crew": [], "illegal_crew": ["C116: Rest period -4.0h below minimum 10h", "C117: Rest period -4.0h below minimum 10h"], "message": "Legal crew: []. Illegal crew: [\'C116: Rest period -4.0h below minimum 10h\', \'C117: Rest period -4.0h below minimum 10h\']"}',
                'Thought: I see that there are two crew members (C116 and C117) who are illegal due to insufficient rest periods, which are 4 hours below the minimum required 10 hours. This indicates that the crew needs to be reassigned or replaced.',
                'Action: find_spare_crew\nAction Input: {"location": "ATL"}',
                'Observation: {"spare_crew": {"crew_id": "S200", "assigned_flight_id": null, "duty_end": null, "status": "active", "base": "ORD", "role": "captain"}, "message": "Found spare crew: S200 at ORD"}',
                'Final Answer: 1. Crew members C116 and C117 are illegal due to insufficient rest periods.\n2. Found spare crew member S200 in ORD, but no local crew in ATL.\n3. Repositioning flight RP009 available from ORD to ATL.\n4. Handoff to Operations Support: "HANDOFF_TO_OPS: [C116, C117] at [ATL] need accommodation due to [insufficient rest period]."',
                'Finished chain.'
            ];
            
            sampleLogs.forEach((log, index) => {
                setTimeout(() => parseAndAddReasoningLog(log), index * 600);
            });
        }
        
        // Auto-load sample data when page loads (remove in production)
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(loadSampleReasoningData, 2000);
        });

        // Enhanced WebSocket message handler to capture reasoning
        const originalHandleSimulationEvent = handleSimulationEvent;
        handleSimulationEvent = function(data) {
            // Call original handler
            originalHandleSimulationEvent(data);
            
            // Extract and parse reasoning data for the reasoning log
            const event = data.event;
            if (event.type === 'crew_analysis' || event.type === 'ops_support') {
                if (event.reasoning) {
                    parseAndAddReasoningLog(event.reasoning);
                }
            }
            
            // Parse LLM events for detailed reasoning
            if (event.type === 'llm_crew_reasoning' || event.type === 'llm_ops_reasoning') {
                const llmEvent = event.llm_event;
                if (llmEvent) {
                    parseAndAddReasoningLog(JSON.stringify(llmEvent));
                }
            }
        };

        // Handle page visibility changes
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                clearInterval(refreshInterval);
            } else {
                startAutoRefresh();
            }
        });
    </script>
</body>
</html>