<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="/static/streaming.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .card { box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075); }
        .status-badge { font-size: 0.875rem; }
        .agent-card { border-left: 4px solid #007bff; }
        .logs-container {
            height: 70vh;
            overflow-y: auto;
            background: #f8f9fa;
            font-family: 'SF Mono', 'Monaco', 'Cascadia Code', 'Roboto Mono', monospace;
            font-size: 0.85rem;
            line-height: 1.4;
            border: 1px solid #e9ecef;
        }
        
        .logs-container.fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 9999;
            background: white;
            border: none;
        }
        
        .log-entry {
            padding: 0.5rem 1rem;
            border-bottom: 1px solid #e9ecef;
            margin: 0;
        }
        
        .log-entry.disruption { border-left: 4px solid #dc3545; }
        .log-entry.analysis { border-left: 4px solid #0dcaf0; }
        .log-entry.resolution { border-left: 4px solid #198754; }
        .log-entry.normal { border-left: 4px solid #6c757d; }
        
        .log-timestamp {
            color: #6c757d;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .log-content {
            margin-top: 0.25rem;
            white-space: pre-wrap;
        }
        
        .reasoning-section {
            background: #f1f3f4;
            padding: 1rem;
            margin: 0.5rem 0;
            border-radius: 4px;
            border: 1px solid #dee2e6;
        }
        
        .reasoning-header {
            font-weight: bold;
            color: #495057;
            border-bottom: 1px solid #dee2e6;
            padding-bottom: 0.5rem;
            margin-bottom: 0.5rem;
        }
        .metric-card { text-align: center; }
        .processing { animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-plane"></i> IOCCA Hub
            </a>
            <span class="navbar-text">
                Irregular Operations Crew Coordination Agent 
            </span>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Status Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="fas fa-tasks text-primary"></i>
                        </h5>
                        <h3 id="active-requests">{{ active_requests }}</h3>
                        <p class="text-muted">Active Requests</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="fas fa-exclamation-triangle text-warning"></i>
                        </h5>
                        <h3 id="total-disruptions">{{ total_disruptions }}</h3>
                        <p class="text-muted">Total Disruptions</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="fas fa-users text-success"></i>
                        </h5>
                        <h3 id="agents-online">3</h3>
                        <p class="text-muted">Agents Online</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="fas fa-heartbeat text-info"></i>
                        </h5>
                        <h3 id="system-status">
                            <span class="badge bg-success">Healthy</span>
                        </h3>
                        <p class="text-muted">System Status</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Control Panel -->
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-control"></i> Control Panel</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="scenario-select" class="form-label">Choose Scenario:</label>
                            <select id="scenario-select" class="form-select">
                                <option value="weather_delay">Weather Delay - Crew Legal</option>
                                <option value="crew_timeout">Crew Duty Time Violation</option>
                                <option value="hotel_shortage">Hotel Capacity Crisis</option>
                                <option value="maintenance_delay">Extended Maintenance</option>
                                <option value="perfect_scenario">Smooth Operations</option>
                            </select>
                        </div>
                        
                        <button id="simulate-disruption" class="btn btn-warning btn-lg w-100 mb-2">
                            <i class="fas fa-bolt"></i> Simulate Disruption
                        </button>
                        
                        <button id="simulate-streaming-disruption" class="btn btn-info btn-lg w-100 mb-2">
                            <i class="fas fa-brain"></i> Streaming LLM Analysis
                        </button>
                        
                        <button id="start-day-simulation" class="btn btn-success btn-lg w-100 mb-3">
                            <i class="fas fa-calendar-day"></i> Start Day Simulation
                        </button>
                        
                        <div class="d-grid gap-2">
                            <button class="btn btn-outline-primary" onclick="refreshDashboard()">
                                <i class="fas fa-sync"></i> Refresh
                            </button>
                            <button class="btn btn-outline-info" onclick="showConfig()">
                                <i class="fas fa-cog"></i> Configuration
                            </button>
                            <button class="btn btn-outline-secondary" onclick="showPolicies()">
                                <i class="fas fa-book"></i> Policies
                            </button>
                            <a href="/streaming" class="btn btn-outline-success">
                                <i class="fas fa-stream"></i> Streaming Test
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Agents Status -->
                <div class="card mt-3">
                    <div class="card-header">
                        <h5><i class="fas fa-robot"></i> Agent Status</h5>
                    </div>
                    <div class="card-body">
                        <div class="agent-card card mb-2">
                            <div class="card-body p-2">
                                <div class="d-flex justify-content-between">
                                    <span>Crew Assignment</span>
                                    <span class="badge bg-success">Online</span>
                                </div>
                            </div>
                        </div>
                        <div class="agent-card card mb-2">
                            <div class="card-body p-2">
                                <div class="d-flex justify-content-between">
                                    <span>Ops Support</span>
                                    <span class="badge bg-success">Online</span>
                                </div>
                            </div>
                        </div>
                        <div class="agent-card card mb-2">
                            <div class="card-body p-2">
                                <div class="d-flex justify-content-between">
                                    <span>Policy LLM</span>
                                    <span class="badge bg-success">Online</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Disruption History -->
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5><i class="fas fa-history"></i> Recent Disruptions</h5>
                        <button class="btn btn-sm btn-outline-primary" onclick="loadDisruptions()">
                            <i class="fas fa-sync"></i>
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="disruptions-list">
                            <div class="text-center text-muted py-4">
                                <i class="fas fa-info-circle"></i>
                                <p>No disruptions to display. Click "Simulate Disruption" to get started.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Live Operations Log -->
                <div class="card mt-3">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5><i class="fas fa-clipboard-list"></i> Operations Log</h5>
                        <div class="btn-group btn-group-sm" role="group">
                            <button type="button" class="btn btn-outline-secondary active" onclick="filterLogs('all')">All</button>
                            <button type="button" class="btn btn-outline-warning" onclick="filterLogs('disruptions')">Disruptions</button>
                            <button type="button" class="btn btn-outline-info" onclick="filterLogs('analysis')">Analysis</button>
                            <button type="button" class="btn btn-outline-success" onclick="filterLogs('resolutions')">Resolutions</button>
                            <button type="button" class="btn btn-outline-primary" onclick="toggleFullscreen()">
                                <i class="fas fa-expand"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div id="logs-container" class="logs-container">
                            <div class="p-3">
                                <small class="text-muted">Operations log will appear here...</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div class="modal fade" id="configModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">System Configuration</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="config-content">Loading...</div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="policiesModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Available Policies</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="policies-content">Loading...</div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global variables
        let refreshInterval;
        let currentDisruptionId = null;
        let currentSimulationId = null;
        let websocket = null;

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            loadScenarios();
            checkSystemHealth();
            loadDisruptions();
            startAutoRefresh();
            connectWebSocket();
        });

        // Load available scenarios
        async function loadScenarios() {
            try {
                const response = await fetch('/api/scenarios');
                const data = await response.json();
                
                const select = document.getElementById('scenario-select');
                select.innerHTML = '';
                
                data.scenarios.forEach(scenario => {
                    const option = document.createElement('option');
                    option.value = scenario.id;
                    option.textContent = scenario.name;
                    option.title = scenario.description;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Failed to load scenarios:', error);
            }
        }

        // Simulate disruption
        document.getElementById('simulate-disruption').addEventListener('click', async function() {
            const button = this;
            const scenarioSelect = document.getElementById('scenario-select');
            const selectedScenario = scenarioSelect.value;
            
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';

            try {
                const response = await fetch(`/api/disruption/simulate?scenario_id=${selectedScenario}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    currentDisruptionId = result.disruption_id;
                    addLog(`Disruption simulation started: ${result.disruption_id}`, 'info');
                    loadDisruptions();
                    monitorDisruption(result.disruption_id);
                } else {
                    addLog(`Error: ${result.detail}`, 'error');
                }
            } catch (error) {
                addLog(`Error: ${error.message}`, 'error');
            } finally {
                button.disabled = false;
                button.innerHTML = '<i class="fas fa-bolt"></i> Simulate Disruption';
            }
        });
        
        // Simulate streaming disruption with live LLM
        document.getElementById('simulate-streaming-disruption').addEventListener('click', async function() {
            const button = this;
            const scenarioSelect = document.getElementById('scenario-select');
            const selectedScenario = scenarioSelect.value;
            
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Streaming...';

            try {
                const response = await fetch(`/api/disruption/simulate-stream?scenario_id=${selectedScenario}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    currentDisruptionId = result.disruption_id;
                    addLog(`🧠 Streaming LLM analysis started: ${result.disruption_id}`, 'info');
                    addLog(`🔴 LIVE: Watch for real-time LLM reasoning tokens below...`, 'analysis');
                    loadDisruptions();
                    monitorDisruption(result.disruption_id);
                } else {
                    addLog(`Error: ${result.detail}`, 'error');
                }
            } catch (error) {
                addLog(`Error: ${error.message}`, 'error');
            } finally {
                button.disabled = false;
                button.innerHTML = '<i class="fas fa-brain"></i> Streaming LLM Analysis';
            }
        });

        // Start day simulation
        document.getElementById('start-day-simulation').addEventListener('click', async function() {
            const button = this;
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Starting...';

            try {
                const response = await fetch('/api/simulation/start-day', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    currentSimulationId = result.simulation_id;
                    addLog(`Day simulation started: ${result.simulation_id}`, 'success');
                    button.innerHTML = '<i class="fas fa-stop"></i> Simulation Running';
                    button.classList.remove('btn-success');
                    button.classList.add('btn-danger');
                } else {
                    addLog(`Error: ${result.detail}`, 'error');
                    button.disabled = false;
                    button.innerHTML = '<i class="fas fa-calendar-day"></i> Start Day Simulation';
                }
            } catch (error) {
                addLog(`Error: ${error.message}`, 'error');
                button.disabled = false;
                button.innerHTML = '<i class="fas fa-calendar-day"></i> Start Day Simulation';
            }
        });

        // WebSocket connection
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws`;
            
            websocket = new WebSocket(wsUrl);
            
            websocket.onopen = function(event) {
                addLog('WebSocket connected - ready for real-time updates', 'info');
            };
            
            websocket.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    handleWebSocketMessage(data);
                } catch (error) {
                    console.error('Error parsing WebSocket message:', error);
                }
            };
            
            websocket.onclose = function(event) {
                addLog('WebSocket disconnected', 'warning');
                // Attempt to reconnect after 5 seconds
                setTimeout(connectWebSocket, 5000);
            };
            
            websocket.onerror = function(error) {
                console.error('WebSocket error:', error);
            };
        }

        // Handle WebSocket messages
        function handleWebSocketMessage(data) {
            if (data.type === 'simulation_event') {
                handleSimulationEvent(data.event);
            } else if (data.type === 'simulation_complete') {
                handleSimulationComplete(data);
            } else if (data.type === 'simulation_error') {
                handleSimulationError(data);
            } else if (data.type === 'llm_reasoning') {
                handleLLMReasoning(data);
            } else if (data.type === 'disruption_complete') {
                handleDisruptionComplete(data);
            } else if (data.type === 'disruption_error') {
                handleDisruptionError(data);
            }
        }

        // Handle LLM reasoning streams
        function handleLLMReasoning(data) {
            const event = data.event;
            const disruptionId = data.disruption_id;
            
            if (event.type === 'token') {
                // Stream individual tokens in real-time
                appendLLMToken(disruptionId, event.content, event.section);
            } else if (event.type === 'reasoning_step') {
                addLog(`🧠 ${event.step.replace(/_/g, ' ').toUpperCase()}: ${event.content}`, 'analysis');
            } else if (event.type === 'reasoning_complete') {
                addLog(`✅ LLM Analysis Complete - Decision: ${event.decision?.substring(0, 100)}...`, 'resolution');
            }
        }
        
        // Handle disruption completion
        function handleDisruptionComplete(data) {
            addLog(`🎉 Streaming disruption analysis completed: ${data.message}`, 'success');
            if (data.results && data.results.final_status) {
                addLog(`📊 Final Status: ${data.results.final_status}`, 'resolution');
            }
        }
        
        // Handle disruption error
        function handleDisruptionError(data) {
            addLog(`❌ Disruption analysis error: ${data.error}`, 'error');
        }
        
        // Track streaming tokens for each disruption
        let streamingBuffers = new Map();
        
        function appendLLMToken(disruptionId, token, section) {
            if (!streamingBuffers.has(disruptionId)) {
                streamingBuffers.set(disruptionId, { 
                    content: '', 
                    section: '', 
                    element: null,
                    lastUpdate: Date.now()
                });
                
                // Create a streaming display area
                const streamElement = createStreamingElement(disruptionId);
                streamingBuffers.get(disruptionId).element = streamElement;
            }
            
            const buffer = streamingBuffers.get(disruptionId);
            
            // Add section header if new section
            if (section && section !== buffer.section) {
                buffer.section = section;
                const sectionHeader = document.createElement('div');
                sectionHeader.className = 'section-header mt-2';
                sectionHeader.innerHTML = `<strong>📋 ${section.replace(/_/g, ' ').toUpperCase()}</strong>`;
                buffer.element.appendChild(sectionHeader);
            }
            
            // Append token with typing effect
            const tokenSpan = document.createElement('span');
            tokenSpan.textContent = token;
            tokenSpan.className = 'token';
            buffer.element.appendChild(tokenSpan);
            
            // Auto-scroll to latest content
            const container = document.getElementById('logs-container');
            container.scrollTop = container.scrollHeight;
            
            // Update buffer
            buffer.content += token;
            buffer.lastUpdate = Date.now();
            
            // Clean up old buffers (after 5 minutes)
            if (Date.now() - buffer.lastUpdate > 300000) {
                streamingBuffers.delete(disruptionId);
            }
        }
        
        function createStreamingElement(disruptionId) {
            const container = document.getElementById('logs-container');
            const timestamp = new Date().toLocaleTimeString();
            
            const streamEntry = document.createElement('div');
            streamEntry.className = 'log-entry analysis';
            streamEntry.setAttribute('data-type', 'analysis');
            streamEntry.id = `stream_${disruptionId}`;
            
            streamEntry.innerHTML = `
                <div class="log-timestamp">${timestamp}</div>
                <div class="reasoning-section">
                    <div class="reasoning-header">
                        🤖 LIVE LLM REASONING - ${disruptionId}
                        <span class="badge bg-info ms-2">STREAMING</span>
                    </div>
                    <div class="stream-content" style="font-family: monospace; line-height: 1.4; min-height: 50px; border: 1px solid #dee2e6; padding: 8px; border-radius: 4px; background: #f8f9fa;"></div>
                </div>
            `;
            
            container.appendChild(streamEntry);
            return streamEntry.querySelector('.stream-content');
        }

        // Handle simulation events
        function handleSimulationEvent(event) {
            const timestamp = new Date().toLocaleTimeString();
            let message = '';
            let logType = 'info';

            switch (event.type) {
                case 'time_update':
                    message = `${event.message}`;
                    logType = 'info';
                    updateSimulationTime(event.sim_time);
                    break;
                case 'normal_operation':
                    message = `NORMAL OPS: ${event.flight_id} (${event.origin} to ${event.destination}) - Departed on schedule`;
                    logType = 'normal';
                    break;
                case 'disruption_detected':
                    message = `DISRUPTION ALERT: ${event.flight_id} - ${event.description}`;
                    logType = 'disruption';
                    break;
                case 'llm_crew_reasoning':
                case 'llm_ops_reasoning':
                    // Handle live LLM reasoning in simulation
                    const llmEvent = event.llm_event;
                    const streamId = `${event.flight_id}_${event.type}`;
                    
                    if (llmEvent.type === 'token') {
                        appendLLMToken(streamId, llmEvent.content, llmEvent.section);
                    } else if (llmEvent.type === 'reasoning_step') {
                        addLog(`🧠 ${event.type.toUpperCase()}: ${llmEvent.step.replace(/_/g, ' ')}`, 'analysis');
                    }
                    return; // Don't add additional log message
                case 'crew_analysis':
                    if (event.llm_powered) {
                        message = `✅ AI CREW ANALYSIS: ${event.flight_id} - LLM decision completed`;
                        if (event.decision) {
                            message += ` - ${event.decision.substring(0, 100)}...`;
                        }
                    } else {
                        message = `CREW ANALYSIS: Evaluating ${event.flight_id} crew assignment options`;
                        // Show detailed reasoning for non-LLM
                        if (event.reasoning) {
                            setTimeout(() => {
                                addReasoningSection(event.reasoning, 'analysis');
                            }, 500);
                        }
                    }
                    logType = 'analysis';
                    break;
                case 'ops_support':
                    if (event.llm_powered) {
                        message = `✅ AI OPS SUPPORT: ${event.location} accommodation - LLM analysis completed`;
                        if (event.decision) {
                            message += ` - ${event.decision.substring(0, 100)}...`;
                        }
                    } else {
                        message = `OPS SUPPORT: Processing crew accommodation at ${event.location}`;
                        // Show detailed ops reasoning for non-LLM
                        if (event.reasoning) {
                            setTimeout(() => {
                                addReasoningSection(event.reasoning, 'analysis');
                            }, 500);
                        }
                    }
                    logType = 'analysis';
                    break;
                case 'disruption_resolved':
                    if (event.llm_powered) {
                        message = `🎉 AI RESOLUTION: ${event.flight_id} - ${event.resolution}`;
                    } else {
                        message = `RESOLUTION: ${event.flight_id} - Multi-agent coordination completed successfully`;
                    }
                    logType = 'resolution';
                    break;
                case 'simulation_complete':
                    message = `🎉 ${event.message}`;
                    logType = 'success';
                    break;
            }

            if (message) {
                addLog(message, logType);
            }
        }

        // Handle simulation completion
        function handleSimulationComplete(data) {
            addLog('Day simulation completed successfully! 🎉', 'success');
            
            const button = document.getElementById('start-day-simulation');
            button.disabled = false;
            button.innerHTML = '<i class="fas fa-calendar-day"></i> Start Day Simulation';
            button.classList.remove('btn-danger');
            button.classList.add('btn-success');
            
            currentSimulationId = null;
        }

        // Handle simulation error
        function handleSimulationError(data) {
            addLog(`Simulation error: ${data.error}`, 'error');
            
            const button = document.getElementById('start-day-simulation');
            button.disabled = false;
            button.innerHTML = '<i class="fas fa-calendar-day"></i> Start Day Simulation';
            button.classList.remove('btn-danger');
            button.classList.add('btn-success');
            
            currentSimulationId = null;
        }

        // Update simulation time display
        function updateSimulationTime(simTime) {
            const time = new Date(simTime);
            const timeStr = time.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            // Update a time display if we add one to the UI
            const timeDisplay = document.getElementById('simulation-time');
            if (timeDisplay) {
                timeDisplay.textContent = `Sim Time: ${timeStr}`;
            }
        }

        // Monitor disruption status
        async function monitorDisruption(disruptionId) {
            const checkStatus = async () => {
                try {
                    const response = await fetch(`/api/disruption/${disruptionId}`);
                    const data = await response.json();
                    
                    if (data.status === 'completed') {
                        addLog(`Disruption ${disruptionId} completed with status: ${data.final_status}`, 'success');
                        loadDisruptions();
                        return;
                    } else if (data.status === 'failed') {
                        addLog(`Disruption ${disruptionId} failed: ${data.error}`, 'error');
                        loadDisruptions();
                        return;
                    }
                    
                    // Continue monitoring
                    setTimeout(checkStatus, 2000);
                } catch (error) {
                    addLog(`Error monitoring disruption: ${error.message}`, 'error');
                }
            };
            
            checkStatus();
        }

        // Load disruptions
        async function loadDisruptions() {
            try {
                const response = await fetch('/api/disruptions');
                const data = await response.json();
                
                const container = document.getElementById('disruptions-list');
                
                if (data.disruptions.length === 0) {
                    container.innerHTML = `
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-info-circle"></i>
                            <p>No disruptions to display. Click "Simulate Disruption" to get started.</p>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = data.disruptions.map(disruption => `
                    <div class="card mb-2">
                        <div class="card-body p-3">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h6 class="mb-1">${disruption.flight_id || 'N/A'}</h6>
                                    <p class="text-muted mb-1">${disruption.description}</p>
                                    <small class="text-muted">${new Date(disruption.timestamp).toLocaleString()}</small>
                                </div>
                                <span class="badge bg-${getStatusColor(disruption.status)} ${disruption.status === 'processing' ? 'processing' : ''}">
                                    ${disruption.status}
                                </span>
                            </div>
                            ${disruption.final_status ? `
                                <div class="mt-2">
                                    <small><strong>Final Status:</strong> ${disruption.final_status}</small>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `).join('');
                
                // Update metrics
                document.getElementById('total-disruptions').textContent = data.total;
                document.getElementById('active-requests').textContent = data.active;
                
            } catch (error) {
                addLog(`Error loading disruptions: ${error.message}`, 'error');
            }
        }

        // Get status color
        function getStatusColor(status) {
            switch (status) {
                case 'completed': return 'success';
                case 'processing': return 'warning';
                case 'failed': return 'danger';
                default: return 'secondary';
            }
        }

        // Check system health
        async function checkSystemHealth() {
            try {
                const response = await fetch('/api/health');
                const data = await response.json();
                
                const statusElement = document.getElementById('system-status');
                statusElement.innerHTML = `<span class="badge bg-${data.status === 'healthy' ? 'success' : 'danger'}">${data.status}</span>`;
                
            } catch (error) {
                document.getElementById('system-status').innerHTML = '<span class="badge bg-danger">Error</span>';
                addLog(`Health check failed: ${error.message}`, 'error');
            }
        }

        // Show configuration
        async function showConfig() {
            try {
                const response = await fetch('/api/config');
                const config = await response.json();
                
                document.getElementById('config-content').innerHTML = `
                    <div class="row">
                        <div class="col-md-6">
                            <h6>RAG Configuration</h6>
                            <ul class="list-unstyled">
                                <li><strong>Model:</strong> ${config.rag.embedding_model}</li>
                                <li><strong>Threshold:</strong> ${config.rag.confidence_threshold}</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6>OpenAI Configuration</h6>
                            <ul class="list-unstyled">
                                <li><strong>Model:</strong> ${config.openai.model}</li>
                                <li><strong>Max Tokens:</strong> ${config.openai.max_tokens}</li>
                                <li><strong>Temperature:</strong> ${config.openai.temperature}</li>
                                <li><strong>API Key:</strong> ${config.openai.api_key_configured ? 'Configured' : 'Not Set'}</li>
                            </ul>
                        </div>
                    </div>
                `;
                
                new bootstrap.Modal(document.getElementById('configModal')).show();
            } catch (error) {
                addLog(`Error loading config: ${error.message}`, 'error');
            }
        }

        // Show policies
        async function showPolicies() {
            try {
                const response = await fetch('/api/policies');
                const data = await response.json();
                
                document.getElementById('policies-content').innerHTML = data.policies.map(policy => `
                    <div class="card mb-2">
                        <div class="card-body">
                            <h6>${policy.title}</h6>
                            <p class="text-muted mb-0">${policy.text}</p>
                            <small class="text-muted">ID: ${policy.id}</small>
                        </div>
                    </div>
                `).join('');
                
                new bootstrap.Modal(document.getElementById('policiesModal')).show();
            } catch (error) {
                addLog(`Error loading policies: ${error.message}`, 'error');
            }
        }

        // Add log entry with professional formatting
        function addLog(message, type = 'info') {
            const container = document.getElementById('logs-container');
            const timestamp = new Date().toLocaleTimeString();
            
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            logEntry.setAttribute('data-type', type);
            
            logEntry.innerHTML = `
                <div class="log-timestamp">${timestamp}</div>
                <div class="log-content">${message}</div>
            `;
            
            container.appendChild(logEntry);
            container.scrollTop = container.scrollHeight;
            
            // Keep only last 100 log entries
            while (container.children.length > 100) {
                container.removeChild(container.firstChild);
            }
        }

        // Add reasoning section with professional formatting
        function addReasoningSection(reasoning, type) {
            const container = document.getElementById('logs-container');
            const timestamp = new Date().toLocaleTimeString();
            
            const reasoningEntry = document.createElement('div');
            reasoningEntry.className = `log-entry ${type}`;
            reasoningEntry.setAttribute('data-type', type);
            
            reasoningEntry.innerHTML = `
                <div class="log-timestamp">${timestamp}</div>
                <div class="reasoning-section">
                    <div class="reasoning-header">DETAILED ANALYSIS</div>
                    <div class="log-content">${reasoning}</div>
                </div>
            `;
            
            container.appendChild(reasoningEntry);
            container.scrollTop = container.scrollHeight;
        }

        // Log filtering functionality
        function filterLogs(filterType) {
            const container = document.getElementById('logs-container');
            const entries = container.querySelectorAll('.log-entry');
            
            // Update button states
            document.querySelectorAll('.btn-group button').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            entries.forEach(entry => {
                if (filterType === 'all') {
                    entry.style.display = 'block';
                } else {
                    const entryType = entry.getAttribute('data-type');
                    if (filterType === 'disruptions' && entryType === 'disruption') {
                        entry.style.display = 'block';
                    } else if (filterType === 'analysis' && entryType === 'analysis') {
                        entry.style.display = 'block';
                    } else if (filterType === 'resolutions' && entryType === 'resolution') {
                        entry.style.display = 'block';
                    } else {
                        entry.style.display = 'none';
                    }
                }
            });
        }

        // Fullscreen toggle
        function toggleFullscreen() {
            const container = document.getElementById('logs-container');
            const button = event.target.closest('button');
            
            if (container.classList.contains('fullscreen')) {
                container.classList.remove('fullscreen');
                button.innerHTML = '<i class="fas fa-expand"></i>';
            } else {
                container.classList.add('fullscreen');
                button.innerHTML = '<i class="fas fa-compress"></i>';
            }
        }

        // Refresh dashboard
        function refreshDashboard() {
            checkSystemHealth();
            loadDisruptions();
            addLog('Dashboard refreshed', 'info');
        }

        // Auto refresh
        function startAutoRefresh() {
            refreshInterval = setInterval(() => {
                checkSystemHealth();
                loadDisruptions();
            }, 10000); // Refresh every 10 seconds
        }

        // Stop auto refresh when page is hidden
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                clearInterval(refreshInterval);
            } else {
                startAutoRefresh();
            }
        });
    </script>
</body>
</html>